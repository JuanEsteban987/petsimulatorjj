<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>BlockPlay - Versi√≥n Funcional</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #1e1e2f;
            color: #fff;
        }
        header {
            background-color: #2d2d44;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        header h1 {
            margin: 0;
            font-size: 1.5rem;
            color: #ffcc00;
        }
        .btn {
            background-color: #4a4a6a;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            border: 1px solid #6a6a8a;
        }
        .btn:hover {
            background-color: #5f5f82;
        }
        .btn.primary {
            background-color: #4CAF50;
        }
        .btn.danger {
            background-color: #f44336;
        }
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .left-panel {
            width: 40%;
            display: flex;
            flex-direction: column;
            border-right: 2px solid #3d3d5a;
        }
        .sprite-editor {
            background-color: #2a2a3c;
            padding: 10px;
            border-bottom: 2px solid #3d3d5a;
            max-height: 300px;
            overflow-y: auto;
        }
        .sprite-editor h3 {
            margin: 0 0 10px 0;
            color: #ffcc00;
            font-size: 1rem;
        }
        .pixel-grid {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 1px;
            background-color: #1a1a2a;
            padding: 5px;
            border-radius: 5px;
        }
        .pixel {
            aspect-ratio: 1;
            background-color: #2d2d44;
            border: 1px solid #4a4a6a;
            cursor: pointer;
        }
        .color-palette {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin: 10px 0;
            justify-content: center;
        }
        .color-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .color-btn.selected {
            border-color: white;
        }
        .preview-canvas {
            width: 48px;
            height: 48px;
            image-rendering: pixelated;
            border: 2px solid #4a4a6a;
            margin-left: 10px;
        }
        .blockly-area {
            flex: 1;
            background-color: #2a2a3c;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 400px;
        }
        .blockly-header {
            padding: 5px;
            background-color: #3d3d5a;
            text-align: center;
            color: #ffcc00;
            font-size: 0.9rem;
        }
        #blocklyDiv {
            flex: 1;
            height: 100%;
            min-height: 300px;
        }
        .canvas-area {
            width: 60%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #1e1e2f;
            padding: 10px;
        }
        #gameCanvas {
            background-color: #2d2d44;
            border: 4px solid #4a4a6a;
            border-radius: 10px;
            width: 100%;
            max-width: 500px;
            height: auto;
            aspect-ratio: 1/1;
            position: relative;
            overflow: hidden;
        }
        .cat-emoji {
            position: absolute;
            font-size: 80px;
            transform-origin: center center;
            transition: transform 0.05s linear;
            pointer-events: none;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .info-panel {
            margin-top: 10px;
            background-color: #2a2a3c;
            padding: 10px 15px;
            border-radius: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            font-size: 0.9rem;
        }
        .info-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .info-value {
            background-color: #1e1e2f;
            padding: 3px 10px;
            border-radius: 15px;
            color: #ffcc00;
        }
        #messageBox {
            background-color: #2a2a3c;
            padding: 5px 15px;
            border-radius: 15px;
            min-width: 150px;
            text-align: center;
        }
        .execution-log {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background-color: rgba(0,0,0,0.8);
            color: #0f0;
            padding: 5px;
            border-radius: 3px;
            font-size: 10px;
            max-width: 150px;
            max-height: 80px;
            overflow-y: auto;
        }
        .error-message {
            color: #ff6b6b;
            padding: 5px;
            text-align: center;
        }
    </style>
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
</head>
<body>
    <header>
        <h1>üê± BlockPlay</h1>
        <button class="btn primary" id="runButton">‚ñ∂ Ejecutar</button>
        <button class="btn" id="resetButton">‚Ü∫ Reiniciar</button>
        <button class="btn danger" id="clearButton">üóë Limpiar</button>
        <button class="btn" id="stopButton">‚èπÔ∏è Detener</button>
        <span id="status" style="color: #ffcc00; margin-left: auto;">Listo</span>
    </header>
    <div class="main-container">
        <div class="left-panel">
            <div class="sprite-editor">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <h3>‚úèÔ∏è Editor 16x16</h3>
                    <canvas id="previewCanvas" class="preview-canvas" width="16" height="16"></canvas>
                </div>
                <div class="pixel-grid" id="pixelGrid"></div>
                <div class="color-palette">
                    <button class="color-btn" style="background-color: #FF6B6B;" data-color="#FF6B6B"></button>
                    <button class="color-btn" style="background-color: #4ECDC4;" data-color="#4ECDC4"></button>
                    <button class="color-btn" style="background-color: #FFD93D;" data-color="#FFD93D"></button>
                    <button class="color-btn" style="background-color: #6BCB77;" data-color="#6BCB77"></button>
                    <button class="color-btn" style="background-color: #9B59B6;" data-color="#9B59B6"></button>
                    <button class="color-btn" style="background-color: #2C3E50;" data-color="#2C3E50"></button>
                </div>
                <div style="display: flex; gap: 5px; justify-content: center;">
                    <button class="btn" id="clearSprite" style="padding: 3px 8px;">Limpiar</button>
                    <button class="btn primary" id="loadDefault" style="padding: 3px 8px;">Gato</button>
                </div>
            </div>
            <div class="blockly-area">
                <div class="blockly-header">üß± Bloques (arrastra y conecta)</div>
                <div id="blocklyDiv"></div>
            </div>
        </div>
        <div class="canvas-area">
            <div id="gameCanvas" style="position: relative;">
                <div id="catEmoji" class="cat-emoji" style="left: 210px; top: 210px;">üê±</div>
                <div id="bubble" style="position: absolute; background: white; color: black; padding: 5px 10px; border-radius: 20px; font-size: 14px; display: none; border: 2px solid black;"></div>
                <div id="executionLog" class="execution-log"></div>
            </div>
            <div class="info-panel">
                <div class="info-item"><span>X:</span><span class="info-value" id="posX">0</span></div>
                <div class="info-item"><span>Y:</span><span class="info-value" id="posY">0</span></div>
                <div class="info-item"><span>√Ångulo:</span><span class="info-value" id="angle">0</span></div>
                <div class="info-item"><span>üí¨</span><span class="info-value" id="messageBox"></span></div>
            </div>
        </div>
    </div>

    <!-- Toolbox simplificada y funcional -->
    <xml id="toolbox" style="display: none">
        <category name="Eventos" colour="#FFC107">
            <block type="when_flag_clicked"></block>
            <block type="when_key_pressed"></block>
        </category>
        <category name="Movimiento" colour="#4CAF50">
            <block type="move_forward">
                <value name="STEPS">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
            <block type="turn_right">
                <value name="DEGREES">
                    <shadow type="math_number">
                        <field name="NUM">15</field>
                    </shadow>
                </value>
            </block>
            <block type="go_to">
                <value name="X">
                    <shadow type="math_number">
                        <field name="NUM">0</field>
                    </shadow>
                </value>
                <value name="Y">
                    <shadow type="math_number">
                        <field name="NUM">0</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category name="Apariencia" colour="#9C27B0">
            <block type="say">
                <value name="MESSAGE">
                    <shadow type="text">
                        <field name="TEXT">Hola</field>
                    </shadow>
                </value>
            </block>
            <block type="set_emoji">
                <value name="EMOJI">
                    <shadow type="text">
                        <field name="TEXT">üê±</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category name="Control" colour="#FF5722">
            <block type="repeat">
                <value name="TIMES">
                    <shadow type="math_number">
                        <field name="NUM">4</field>
                    </shadow>
                </value>
            </block>
            <block type="wait">
                <value name="SECONDS">
                    <shadow type="math_number">
                        <field name="NUM">0.5</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category name="Operadores" colour="#607D8B">
            <block type="math_number"></block>
            <block type="text"></block>
        </category>
    </xml>

    <script>
        // --- Estado del gato ---
        let cat = {
            x: 0, y: 0, angle: 0,
            emoji: 'üê±',
            message: '',
            messageTimer: null
        };

        // Variables de control
        let isRunning = false;
        let shouldStop = false;
        let executionQueue = [];
        let statusSpan = document.getElementById('status');
        let logDiv = document.getElementById('executionLog');

        // Elementos DOM
        const catEmoji = document.getElementById('catEmoji');
        const bubble = document.getElementById('bubble');
        const posXSpan = document.getElementById('posX');
        const posYSpan = document.getElementById('posY');
        const angleSpan = document.getElementById('angle');
        const messageBox = document.getElementById('messageBox');
        const previewCanvas = document.getElementById('previewCanvas');
        const previewCtx = previewCanvas.getContext('2d');

        // --- Sprite (opcional, no afecta al emoji) ---
        let spriteData = new Array(256).fill('#2C3E50');
        let selectedColor = '#FF6B6B';
        let isDrawing = false;

        // --- Funciones de utilidad ---
        function log(message) {
            console.log(message);
            logDiv.innerHTML = message + '<br>' + logDiv.innerHTML;
            if (logDiv.children.length > 5) logDiv.removeChild(logDiv.lastChild);
        }

        function updateStatus(text) {
            statusSpan.textContent = text;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // --- Funciones de movimiento (s√≠ncronas para actualizaci√≥n inmediata) ---
        function updateCatDisplay() {
            // Convertir coordenadas (-200 a 200) a p√≠xeles (centro del canvas)
            const canvas = document.getElementById('gameCanvas');
            const centerX = canvas.clientWidth / 2 - 40; // 40 es mitad del emoji (80px/2)
            const centerY = canvas.clientHeight / 2 - 40;
            
            catEmoji.style.left = (centerX + cat.x) + 'px';
            catEmoji.style.top = (centerY + cat.y) + 'px';
            catEmoji.style.transform = `rotate(${cat.angle}deg)`;
            
            // Actualizar info
            posXSpan.textContent = Math.round(cat.x);
            posYSpan.textContent = Math.round(cat.y);
            angleSpan.textContent = cat.angle;
            
            // Actualizar bocadillo
            if (cat.message) {
                bubble.style.display = 'block';
                bubble.textContent = cat.message;
                bubble.style.left = (centerX + cat.x + 50) + 'px';
                bubble.style.top = (centerY + cat.y - 50) + 'px';
                messageBox.textContent = cat.message;
            } else {
                bubble.style.display = 'none';
                messageBox.textContent = '(vac√≠o)';
            }
        }

        // --- API de acciones (AHORA SON S√çNCRONAS PARA SIMPLIFICAR) ---
        function mover(pasos) {
            if (shouldStop) return;
            let rad = cat.angle * Math.PI / 180;
            cat.x += Math.cos(rad) * pasos;
            cat.y -= Math.sin(rad) * pasos;
            // Limitar
            cat.x = Math.min(200, Math.max(-200, cat.x));
            cat.y = Math.min(200, Math.max(-200, cat.y));
            updateCatDisplay();
            log(`Mover ${pasos} pasos`);
        }

        function girar(grados) {
            if (shouldStop) return;
            cat.angle = (cat.angle + grados) % 360;
            updateCatDisplay();
            log(`Girar ${grados}¬∞`);
        }

        function irA(x, y) {
            if (shouldStop) return;
            cat.x = Math.min(200, Math.max(-200, Number(x) || 0));
            cat.y = Math.min(200, Math.max(-200, Number(y) || 0));
            updateCatDisplay();
            log(`Ir a (${x}, ${y})`);
        }

        function decir(texto) {
            if (shouldStop) return;
            if (cat.messageTimer) clearTimeout(cat.messageTimer);
            cat.message = String(texto);
            updateCatDisplay();
            log(`Decir: "${texto}"`);
            cat.messageTimer = setTimeout(() => {
                cat.message = '';
                updateCatDisplay();
            }, 1000);
        }

        function cambiarEmoji(emoji) {
            if (shouldStop) return;
            cat.emoji = String(emoji);
            catEmoji.textContent = cat.emoji;
            log(`Emoji: ${emoji}`);
        }

        // --- Definici√≥n de bloques Blockly (CORREGIDA) ---
        Blockly.Blocks['when_flag_clicked'] = {
            init: function() {
                this.appendDummyInput().appendField('‚öë al hacer clic en bandera');
                this.appendStatementInput('DO').setCheck(null);
                this.setColour('#FFC107');
                this.setPreviousStatement(false);
                this.setNextStatement(false);
            }
        };

        Blockly.Blocks['when_key_pressed'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField('‚å®Ô∏è tecla')
                    .appendField(new Blockly.FieldDropdown([
                        ['espacio', 'Space'],
                        ['arriba', 'ArrowUp'],
                        ['abajo', 'ArrowDown'],
                        ['izquierda', 'ArrowLeft'],
                        ['derecha', 'ArrowRight']
                    ]), 'KEY')
                    .appendField('presionada');
                this.appendStatementInput('DO').setCheck(null);
                this.setColour('#FFC107');
                this.setPreviousStatement(false);
                this.setNextStatement(false);
            }
        };

        Blockly.Blocks['move_forward'] = {
            init: function() {
                this.appendDummyInput().appendField('mover');
                this.appendValueInput('STEPS').setCheck('Number').appendField('pasos');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#4CAF50');
            }
        };

        Blockly.Blocks['turn_right'] = {
            init: function() {
                this.appendDummyInput().appendField('girar');
                this.appendValueInput('DEGREES').setCheck('Number').appendField('grados derecha');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#4CAF50');
            }
        };

        Blockly.Blocks['go_to'] = {
            init: function() {
                this.appendDummyInput().appendField('ir a X');
                this.appendValueInput('X').setCheck('Number').appendField('');
                this.appendDummyInput().appendField('Y');
                this.appendValueInput('Y').setCheck('Number').appendField('');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#4CAF50');
            }
        };

        Blockly.Blocks['say'] = {
            init: function() {
                this.appendDummyInput().appendField('decir');
                this.appendValueInput('MESSAGE').setCheck('String').appendField('');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#9C27B0');
            }
        };

        Blockly.Blocks['set_emoji'] = {
            init: function() {
                this.appendDummyInput().appendField('cambiar emoji a');
                this.appendValueInput('EMOJI').setCheck('String').appendField('');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#9C27B0');
            }
        };

        Blockly.Blocks['repeat'] = {
            init: function() {
                this.appendDummyInput().appendField('repetir');
                this.appendValueInput('TIMES').setCheck('Number').appendField('veces');
                this.appendStatementInput('DO').setCheck(null).appendField('hacer');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#FF5722');
            }
        };

        Blockly.Blocks['wait'] = {
            init: function() {
                this.appendDummyInput().appendField('esperar');
                this.appendValueInput('SECONDS').setCheck('Number').appendField('segundos');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#FF5722');
            }
        };

        // --- Generadores de c√≥digo JavaScript (CORREGIDOS) ---
        Blockly.JavaScript['when_flag_clicked'] = function(block) {
            let statements = Blockly.JavaScript.statementToCode(block, 'DO');
            return statements;
        };

        Blockly.JavaScript['when_key_pressed'] = function(block) {
            let key = block.getFieldValue('KEY');
            let statements = Blockly.JavaScript.statementToCode(block, 'DO');
            return `window.addEventListener('keydown', function(e) {
                if(e.code === '${key}' && !shouldStop) {
                    ${statements}
                }
            });\n`;
        };

        Blockly.JavaScript['move_forward'] = function(block) {
            let steps = Blockly.JavaScript.valueToCode(block, 'STEPS', Blockly.JavaScript.ORDER_NONE) || '10';
            return `mover(${steps});\n`;
        };

        Blockly.JavaScript['turn_right'] = function(block) {
            let degrees = Blockly.JavaScript.valueToCode(block, 'DEGREES', Blockly.JavaScript.ORDER_NONE) || '15';
            return `girar(${degrees});\n`;
        };

        Blockly.JavaScript['go_to'] = function(block) {
            let x = Blockly.JavaScript.valueToCode(block, 'X', Blockly.JavaScript.ORDER_NONE) || '0';
            let y = Blockly.JavaScript.valueToCode(block, 'Y', Blockly.JavaScript.ORDER_NONE) || '0';
            return `irA(${x}, ${y});\n`;
        };

        Blockly.JavaScript['say'] = function(block) {
            let message = Blockly.JavaScript.valueToCode(block, 'MESSAGE', Blockly.JavaScript.ORDER_NONE) || "'Hola'";
            return `decir(${message});\n`;
        };

        Blockly.JavaScript['set_emoji'] = function(block) {
            let emoji = Blockly.JavaScript.valueToCode(block, 'EMOJI', Blockly.JavaScript.ORDER_NONE) || "'üê±'";
            return `cambiarEmoji(${emoji});\n`;
        };

        Blockly.JavaScript['repeat'] = function(block) {
            let times = Blockly.JavaScript.valueToCode(block, 'TIMES', Blockly.JavaScript.ORDER_ASSIGNMENT) || '4';
            let statements = Blockly.JavaScript.statementToCode(block, 'DO');
            return `for(let i=0; i<${times}; i++) { if(shouldStop) break; ${statements} }\n`;
        };

        Blockly.JavaScript['wait'] = function(block) {
            let seconds = Blockly.JavaScript.valueToCode(block, 'SECONDS', Blockly.JavaScript.ORDER_NONE) || '0.5';
            return `await wait(${seconds});\n`;
        };

        // --- Inicializar Blockly ---
        const workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'),
            trashcan: true,
            scrollbars: true,
            horizontalLayout: false,
            toolboxPosition: 'start',
            sounds: false
        });

        // Agregar bloques de ejemplo
        function loadExample() {
            const xml = '<xml>' +
                '<block type="when_flag_clicked" x="20" y="20">' +
                '<statement name="DO">' +
                '<block type="repeat">' +
                '<value name="TIMES"><shadow type="math_number"><field name="NUM">4</field></shadow></value>' +
                '<statement name="DO">' +
                '<block type="move_forward">' +
                '<value name="STEPS"><shadow type="math_number"><field name="NUM">50</field></shadow></value>' +
                '<next>' +
                '<block type="say">' +
                '<value name="MESSAGE"><shadow type="text"><field name="TEXT">Miau</field></shadow></value>' +
                '<next>' +
                '<block type="wait">' +
                '<value name="SECONDS"><shadow type="math_number"><field name="NUM">0.3</field></shadow></value>' +
                '<next>' +
                '<block type="turn_right">' +
                '<value name="DEGREES"><shadow type="math_number"><field name="NUM">90</field></shadow></value>' +
                '</block></next></block></next></block></next></block>' +
                '</statement></block>' +
                '</statement></block>' +
                '<block type="when_key_pressed" x="20" y="250">' +
                '<field name="KEY">Space</field>' +
                '<statement name="DO">' +
                '<block type="set_emoji">' +
                '<value name="EMOJI"><shadow type="text"><field name="TEXT">üò∫</field></shadow></value>' +
                '</block>' +
                '</statement>' +
                '</block>' +
                '</xml>';
            Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(xml), workspace);
        }

        loadExample();

        // --- Botones ---
        document.getElementById('runButton').addEventListener('click', async function() {
            if (isRunning) {
                log('Ya est√° en ejecuci√≥n');
                return;
            }
            
            shouldStop = false;
            isRunning = true;
            updateStatus('Ejecutando...');
            
            // Obtener c√≥digo
            let code = Blockly.JavaScript.workspaceToCode(workspace);
            console.log('C√≥digo:', code);
            
            // Buscar solo el c√≥digo de bandera (simplificado)
            // Ejecutar en una funci√≥n async
            try {
                // Crear funci√≥n con todas las dependencias
                const executeCode = new Function(
                    'mover', 'girar', 'irA', 'decir', 'cambiarEmoji', 'wait', 'shouldStop',
                    `return (async function() {
                        ${code}
                    })();`
                );
                
                await executeCode(mover, girar, irA, decir, cambiarEmoji, 
                    async (seconds) => {
                        if (shouldStop) return;
                        log(`Esperar ${seconds}s`);
                        await sleep(seconds * 1000);
                    }, 
                    shouldStop
                );
            } catch (e) {
                console.error('Error:', e);
                log('Error: ' + e.message);
            } finally {
                isRunning = false;
                updateStatus('Completado');
            }
        });

        document.getElementById('stopButton').addEventListener('click', function() {
            shouldStop = true;
            isRunning = false;
            updateStatus('Detenido');
            log('Ejecuci√≥n detenida');
        });

        document.getElementById('resetButton').addEventListener('click', function() {
            shouldStop = true;
            isRunning = false;
            cat.x = 0; cat.y = 0; cat.angle = 0;
            cat.emoji = 'üê±';
            cat.message = '';
            catEmoji.textContent = cat.emoji;
            if (cat.messageTimer) clearTimeout(cat.messageTimer);
            updateCatDisplay();
            updateStatus('Reiniciado');
            log('Posici√≥n reiniciada');
        });

        document.getElementById('clearButton').addEventListener('click', function() {
            workspace.clear();
            loadExample(); // Recargar ejemplo
            log('Bloques limpiados');
        });

        // --- Editor de p√≠xeles ---
        function createPixelGrid() {
            const grid = document.getElementById('pixelGrid');
            grid.innerHTML = '';
            for (let i = 0; i < 256; i++) {
                const pixel = document.createElement('div');
                pixel.className = 'pixel';
                pixel.dataset.index = i;
                pixel.style.backgroundColor = spriteData[i];
                pixel.addEventListener('mousedown', (e) => {
                    isDrawing = true;
                    paintPixel(e.target.dataset.index);
                });
                pixel.addEventListener('mouseover', (e) => {
                    if (isDrawing) paintPixel(e.target.dataset.index);
                });
                grid.appendChild(pixel);
            }
            document.addEventListener('mouseup', () => { isDrawing = false; });
        }

        function paintPixel(index) {
            spriteData[index] = selectedColor;
            document.querySelector(`[data-index="${index}"]`).style.backgroundColor = selectedColor;
            updatePreview();
        }

        function updatePreview() {
            previewCtx.clearRect(0, 0, 16, 16);
            for (let i = 0; i < 256; i++) {
                previewCtx.fillStyle = spriteData[i];
                previewCtx.fillRect(i % 16, Math.floor(i / 16), 1, 1);
            }
        }

        // Selector de color
        document.querySelectorAll('.color-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedColor = btn.dataset.color;
            });
        });

        document.getElementById('clearSprite').addEventListener('click', () => {
            spriteData.fill('#2C3E50');
            document.querySelectorAll('.pixel').forEach((p, i) => p.style.backgroundColor = spriteData[i]);
            updatePreview();
        });

        document.getElementById('loadDefault').addEventListener('click', () => {
            // Gato simple
            spriteData.fill('#2C3E50');
            for (let i = 0; i < 256; i++) {
                let x = i % 16, y = Math.floor(i / 16);
                if (x >= 5 && x <= 10 && y >= 4 && y <= 11) {
                    spriteData[i] = '#FFB347';
                }
            }
            // Ojos
            spriteData[6*16+7] = '#FFFFFF';
            spriteData[6*16+8] = '#FFFFFF';
            spriteData[7*16+7] = '#000000';
            spriteData[7*16+8] = '#000000';
            document.querySelectorAll('.pixel').forEach((p, i) => p.style.backgroundColor = spriteData[i]);
            updatePreview();
        });

        // Inicializar
        createPixelGrid();
        updatePreview();
        updateCatDisplay();

        // Hacer que Blockly se redimensione
        window.addEventListener('resize', () => {
            Blockly.svgResize(workspace);
        });

        // Eventos de teclado globales
        window.addEventListener('keydown', (e) => {
            console.log('Tecla:', e.code);
        });

        log('Sistema listo');
    </script>
</body>
</html>

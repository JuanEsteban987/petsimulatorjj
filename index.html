<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>BlockPlay - Editor de Sprite + Bloques estilo Scratch</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #1e1e2f;
            color: #fff;
        }
        header {
            background-color: #2d2d44;
            color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 10;
        }
        header h1 {
            margin: 0;
            font-size: 1.8rem;
            background: linear-gradient(45deg, #ffcc00, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .btn {
            background-color: #4a4a6a;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.2s;
            border: 1px solid #6a6a8a;
        }
        .btn:hover {
            background-color: #5f5f82;
            transform: scale(1.02);
        }
        .btn.primary {
            background-color: #4CAF50;
            border-color: #6ccf70;
        }
        .btn.primary:hover {
            background-color: #5fcf64;
        }
        .btn.danger {
            background-color: #f44336;
            border-color: #ff6b6b;
        }
        .btn.danger:hover {
            background-color: #ff5f52;
        }
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .left-panel {
            width: 40%;
            display: flex;
            flex-direction: column;
            border-right: 2px solid #3d3d5a;
        }
        .sprite-editor {
            background-color: #2a2a3c;
            padding: 15px;
            border-bottom: 2px solid #3d3d5a;
        }
        .sprite-editor h3 {
            margin: 0 0 15px 0;
            color: #ffcc00;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .pixel-grid {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 2px;
            background-color: #1a1a2a;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .pixel {
            aspect-ratio: 1;
            background-color: #2d2d44;
            border: 1px solid #4a4a6a;
            cursor: pointer;
            transition: 0.1s;
        }
        .pixel:hover {
            transform: scale(1.1);
            border-color: #ffcc00;
        }
        .color-palette {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
            justify-content: center;
        }
        .color-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: 0.2s;
        }
        .color-btn:hover {
            transform: scale(1.1);
        }
        .color-btn.selected {
            border-color: white;
            box-shadow: 0 0 10px currentColor;
        }
        .preview-canvas {
            width: 64px;
            height: 64px;
            image-rendering: pixelated;
            border: 2px solid #4a4a6a;
            border-radius: 5px;
            margin-left: 15px;
        }
        .blockly-area {
            flex: 1;
            background-color: #2a2a3c;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .blockly-header {
            padding: 8px;
            background-color: #3d3d5a;
            font-weight: bold;
            text-align: center;
            color: #ffcc00;
        }
        #blocklyDiv {
            flex: 1;
            height: 100%;
            min-height: 400px;
        }
        .canvas-area {
            width: 60%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #1e1e2f;
            padding: 20px;
            position: relative;
        }
        #gameCanvas {
            background-color: #2d2d44;
            border: 4px solid #4a4a6a;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 600px;
            height: auto;
            aspect-ratio: 1/1;
            image-rendering: pixelated;
        }
        .info-panel {
            margin-top: 20px;
            background-color: #2a2a3c;
            padding: 15px 25px;
            border-radius: 30px;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            justify-content: center;
            border: 1px solid #4a4a6a;
        }
        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .info-label {
            color: #aaa;
        }
        .info-value {
            background-color: #1e1e2f;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            color: #ffcc00;
        }
        #messageBox {
            background-color: #2a2a3c;
            padding: 10px 20px;
            border-radius: 20px;
            min-width: 200px;
            text-align: center;
            border: 1px solid #4a4a6a;
        }
    </style>
    <!-- Cargar Blockly desde CDN -->
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
</head>
<body>
    <header>
        <h1>üé® BlockPlay ¬∑ Editor de Sprite + Bloques</h1>
        <button class="btn primary" id="runButton">‚ñ∂ Ejecutar programa</button>
        <button class="btn" id="resetButton">‚Ü∫ Reiniciar gato</button>
        <button class="btn danger" id="clearButton">üóë Limpiar bloques</button>
    </header>
    <div class="main-container">
        <div class="left-panel">
            <div class="sprite-editor">
                <h3>
                    <span>‚úèÔ∏è Editor de Sprite (16x16)</span>
                    <canvas id="previewCanvas" class="preview-canvas" width="16" height="16"></canvas>
                </h3>
                <div class="pixel-grid" id="pixelGrid"></div>
                <div class="color-palette">
                    <button class="color-btn" style="background-color: #FF6B6B;" data-color="#FF6B6B"></button>
                    <button class="color-btn" style="background-color: #4ECDC4;" data-color="#4ECDC4"></button>
                    <button class="color-btn" style="background-color: #FFD93D;" data-color="#FFD93D"></button>
                    <button class="color-btn" style="background-color: #6BCB77;" data-color="#6BCB77"></button>
                    <button class="color-btn" style="background-color: #9B59B6;" data-color="#9B59B6"></button>
                    <button class="color-btn" style="background-color: #FF9F1C;" data-color="#FF9F1C"></button>
                    <button class="color-btn" style="background-color: #2C3E50;" data-color="#2C3E50"></button>
                    <button class="color-btn" style="background-color: #E67E22;" data-color="#E67E22"></button>
                    <button class="color-btn" style="background-color: #1ABC9C;" data-color="#1ABC9C"></button>
                    <button class="color-btn" style="background-color: #E74C3C;" data-color="#E74C3C"></button>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn" id="clearSprite">Limpiar Sprite</button>
                    <button class="btn primary" id="loadDefault">Gato por defecto</button>
                </div>
            </div>
            <div class="blockly-area">
                <div class="blockly-header">üß± Bloques de programaci√≥n (arrastra desde la caja)</div>
                <div id="blocklyDiv"></div>
            </div>
        </div>
        <div class="canvas-area">
            <canvas id="gameCanvas" width="400" height="400"></canvas>
            <div class="info-panel">
                <div class="info-item">
                    <span class="info-label">üê± Posici√≥n:</span>
                    <span class="info-value" id="posX">200</span>
                    <span class="info-value" id="posY">200</span>
                </div>
                <div class="info-item">
                    <span class="info-label">‚Üª Direcci√≥n:</span>
                    <span class="info-value" id="angle">0</span>
                </div>
                <div class="info-item">
                    <span class="info-label">üí¨ Mensaje:</span>
                    <span class="info-value" id="messageBox"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Toolbox mejorada con m√°s bloques -->
    <xml id="toolbox" style="display: none">
        <category name="Eventos" colour="#FFC107">
            <block type="when_flag_clicked"></block>
            <block type="when_key_pressed"></block>
        </category>
        <category name="Movimiento" colour="#4CAF50">
            <block type="move_forward">
                <value name="STEPS">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
            <block type="move_backward">
                <value name="STEPS">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
            <block type="turn_right">
                <value name="DEGREES">
                    <shadow type="math_number">
                        <field name="NUM">15</field>
                    </shadow>
                </value>
            </block>
            <block type="turn_left">
                <value name="DEGREES">
                    <shadow type="math_number">
                        <field name="NUM">15</field>
                    </shadow>
                </value>
            </block>
            <block type="go_to">
                <value name="X">
                    <shadow type="math_number">
                        <field name="NUM">200</field>
                    </shadow>
                </value>
                <value name="Y">
                    <shadow type="math_number">
                        <field name="NUM">200</field>
                    </shadow>
                </value>
            </block>
            <block type="point_towards"></block>
        </category>
        <category name="Apariencia" colour="#9C27B0">
            <block type="say">
                <value name="MESSAGE">
                    <shadow type="text">
                        <field name="TEXT">¬°Hola!</field>
                    </shadow>
                </value>
            </block>
            <block type="think">
                <value name="MESSAGE">
                    <shadow type="text">
                        <field name="TEXT">ü§î...</field>
                    </shadow>
                </value>
            </block>
            <block type="set_color">
                <value name="COLOR">
                    <shadow type="colour_picker">
                        <field name="COLOUR">#FF6B6B</field>
                    </shadow>
                </value>
            </block>
            <block type="change_size">
                <value name="SIZE">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category name="Sonido" colour="#00BCD4">
            <block type="play_sound"></block>
            <block type="beep"></block>
        </category>
        <category name="Control" colour="#FF5722">
            <block type="repeat">
                <value name="TIMES">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
            <block type="wait">
                <value name="SECONDS">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
            </block>
            <block type="if_then"></block>
        </category>
        <category name="Operadores" colour="#607D8B">
            <block type="math_number"></block>
            <block type="text"></block>
            <block type="colour_picker"></block>
            <block type="math_arithmetic"></block>
        </category>
    </xml>

    <script>
        // ---------- Configuraci√≥n del gato ----------
        let cat = {
            x: 200,
            y: 200,
            angle: 0,
            sayText: '',
            sayTimer: null,
            thinkText: '',
            thinkTimer: null,
            color: '#FF6B6B',
            size: 20
        };

        // Sprite personalizado (16x16 p√≠xeles)
        let spriteData = new Array(16 * 16).fill('#2C3E50'); // Color por defecto (fondo)
        
        // Sprite por defecto (gato pixel art)
        const defaultSprite = [
            '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50',
            '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50',
            '#2C3E50', '#2C3E50', '#2C3E50', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#2C3E50', '#2C3E50', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#2C3E50', '#2C3E50', '#2C3E50',
            '#2C3E50', '#2C3E50', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#2C3E50', '#2C3E50',
            '#2C3E50', '#2C3E50', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#2C3E50', '#2C3E50',
            '#2C3E50', '#2C3E50', '#FF6B6B', '#FF6B6B', '#FFFFFF', '#FFFFFF', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FFFFFF', '#FFFFFF', '#FF6B6B', '#FF6B6B', '#2C3E50', '#2C3E50',
            '#2C3E50', '#2C3E50', '#FF6B6B', '#FF6B6B', '#FFFFFF', '#FFFFFF', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FFFFFF', '#FFFFFF', '#FF6B6B', '#FF6B6B', '#2C3E50', '#2C3E50',
            '#2C3E50', '#2C3E50', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#2C3E50', '#2C3E50',
            '#2C3E50', '#2C3E50', '#2C3E50', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#2C3E50', '#2C3E50', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#FF6B6B', '#2C3E50', '#2C3E50', '#2C3E50',
            '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#FF6B6B', '#FF6B6B', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#FF6B6B', '#FF6B6B', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50',
            '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#FF6B6B', '#FF6B6B', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#FF6B6B', '#FF6B6B', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50',
            '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50',
            '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50',
            '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50',
            '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50',
            '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50', '#2C3E50'
        ];

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const posXSpan = document.getElementById('posX');
        const posYSpan = document.getElementById('posY');
        const angleSpan = document.getElementById('angle');
        const messageBox = document.getElementById('messageBox');
        const previewCanvas = document.getElementById('previewCanvas');
        const previewCtx = previewCanvas.getContext('2d');

        let selectedColor = '#FF6B6B';
        let isDrawing = false;

        // Crear grid de p√≠xeles
        const pixelGrid = document.getElementById('pixelGrid');
        function createPixelGrid() {
            pixelGrid.innerHTML = '';
            for (let i = 0; i < 256; i++) {
                const pixel = document.createElement('div');
                pixel.className = 'pixel';
                pixel.dataset.index = i;
                pixel.style.backgroundColor = spriteData[i];
                pixel.addEventListener('mousedown', (e) => {
                    isDrawing = true;
                    paintPixel(e.target.dataset.index);
                });
                pixel.addEventListener('mouseover', (e) => {
                    if (isDrawing) paintPixel(e.target.dataset.index);
                });
                pixel.addEventListener('mouseup', () => { isDrawing = false; });
                pixelGrid.appendChild(pixel);
            }
            document.addEventListener('mouseup', () => { isDrawing = false; });
        }

        function paintPixel(index) {
            spriteData[index] = selectedColor;
            document.querySelector(`[data-index="${index}"]`).style.backgroundColor = selectedColor;
            updatePreview();
        }

        function updatePreview() {
            previewCtx.clearRect(0, 0, 16, 16);
            for (let i = 0; i < 256; i++) {
                const x = i % 16;
                const y = Math.floor(i / 16);
                previewCtx.fillStyle = spriteData[i];
                previewCtx.fillRect(x, y, 1, 1);
            }
            drawCat(); // Redibujar el gato con el nuevo sprite
        }

        // Cargar sprite por defecto
        function loadDefaultSprite() {
            spriteData = [...defaultSprite];
            const pixels = document.querySelectorAll('.pixel');
            pixels.forEach((pixel, i) => {
                pixel.style.backgroundColor = spriteData[i];
            });
            updatePreview();
        }

        // Limpiar sprite
        document.getElementById('clearSprite').addEventListener('click', () => {
            spriteData = new Array(256).fill('#2C3E50');
            const pixels = document.querySelectorAll('.pixel');
            pixels.forEach((pixel, i) => {
                pixel.style.backgroundColor = spriteData[i];
            });
            updatePreview();
        });

        document.getElementById('loadDefault').addEventListener('click', loadDefaultSprite);

        // Selector de color
        document.querySelectorAll('.color-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedColor = btn.dataset.color;
            });
        });
        document.querySelector('.color-btn').classList.add('selected');

        // Dibujar el gato con el sprite personalizado
        function drawCat() {
            ctx.clearRect(0, 0, 400, 400);

            // Fondo cuadr√≠cula
            ctx.fillStyle = '#2d2d44';
            ctx.fillRect(0, 0, 400, 400);
            ctx.strokeStyle = '#4a4a6a';
            ctx.lineWidth = 0.5;
            for (let i = 0; i <= 400; i += 20) {
                ctx.beginPath();
                ctx.strokeStyle = '#3d3d5a';
                ctx.lineWidth = 0.5;
                ctx.moveTo(i, 0);
                ctx.lineTo(i, 400);
                ctx.stroke();
                ctx.moveTo(0, i);
                ctx.lineTo(400, i);
                ctx.stroke();
            }

            // Dibujar sprite pixel art
            const size = cat.size * 2; // Escalar el sprite
            const startX = cat.x - 16;
            const startY = cat.y - 16;

            for (let i = 0; i < 256; i++) {
                const px = i % 16;
                const py = Math.floor(i / 16);
                ctx.fillStyle = spriteData[i];
                ctx.fillRect(startX + px * 2, startY + py * 2, 2, 2);
            }

            // Direcci√≥n (l√≠nea)
            ctx.beginPath();
            ctx.strokeStyle = '#ffcc00';
            ctx.lineWidth = 2;
            ctx.moveTo(cat.x, cat.y);
            const rad = cat.angle * Math.PI / 180;
            ctx.lineTo(cat.x + Math.cos(rad) * 30, cat.y - Math.sin(rad) * 30);
            ctx.stroke();

            // Mensajes
            if (cat.sayText) {
                ctx.fillStyle = 'white';
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.ellipse(cat.x + 30, cat.y - 30, 50, 25, 0, 0, 2 * Math.PI);
                ctx.fill();
                ctx.stroke();
                ctx.fillStyle = '#333';
                ctx.font = 'bold 14px Arial';
                ctx.fillText(cat.sayText, cat.x + 10, cat.y - 35);
            }

            if (cat.thinkText) {
                ctx.fillStyle = 'rgba(255,255,255,0.9)';
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.ellipse(cat.x + 30, cat.y - 30, 50, 25, 0, 0, 2 * Math.PI);
                ctx.fill();
                ctx.stroke();
                ctx.fillStyle = '#333';
                ctx.font = 'bold 14px Arial';
                ctx.fillText('üí≠ ' + cat.thinkText, cat.x + 10, cat.y - 35);
            }

            // Actualizar info
            posXSpan.textContent = Math.round(cat.x);
            posYSpan.textContent = Math.round(cat.y);
            angleSpan.textContent = cat.angle;
            messageBox.textContent = cat.sayText || cat.thinkText || '(vac√≠o)';
        }

        // ---------- API de acciones ----------
        function mover(pasos) {
            let rad = cat.angle * Math.PI / 180;
            cat.x += Math.cos(rad) * pasos;
            cat.y -= Math.sin(rad) * pasos;
            cat.x = Math.min(380, Math.max(20, cat.x));
            cat.y = Math.min(380, Math.max(20, cat.y));
            drawCat();
        }

        function moverAtras(pasos) {
            mover(-pasos);
        }

        function girar(grados) {
            cat.angle = (cat.angle + grados) % 360;
            drawCat();
        }

        function girarIzquierda(grados) {
            girar(-grados);
        }

        function irA(x, y) {
            cat.x = Math.min(380, Math.max(20, Number(x) || 200));
            cat.y = Math.min(380, Math.max(20, Number(y) || 200));
            drawCat();
        }

        function apuntarHacia(x, y) {
            let dx = x - cat.x;
            let dy = cat.y - y; // Invertido por coordenadas canvas
            cat.angle = Math.atan2(dy, dx) * 180 / Math.PI;
            drawCat();
        }

        function decir(texto) {
            if (cat.sayTimer) clearTimeout(cat.sayTimer);
            cat.sayText = String(texto);
            cat.thinkText = '';
            drawCat();
            cat.sayTimer = setTimeout(() => {
                cat.sayText = '';
                drawCat();
            }, 1500);
        }

        function pensar(texto) {
            if (cat.thinkTimer) clearTimeout(cat.thinkTimer);
            cat.thinkText = String(texto);
            cat.sayText = '';
            drawCat();
            cat.thinkTimer = setTimeout(() => {
                cat.thinkText = '';
                drawCat();
            }, 1500);
        }

        function cambiarColor(color) {
            cat.color = color;
            drawCat();
        }

        function cambiarSize(size) {
            cat.size = Math.min(40, Math.max(10, Number(size) || 20));
            drawCat();
        }

        function playSound() {
            // Simular sonido con beep
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.frequency.value = 440;
            gainNode.gain.value = 0.1;
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.1);
        }

        function beep() {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            oscillator.connect(audioCtx.destination);
            oscillator.frequency.value = 880;
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.05);
        }

        function wait(seconds) {
            return new Promise(resolve => setTimeout(resolve, seconds * 1000));
        }

        function resetCat() {
            cat.x = 200;
            cat.y = 200;
            cat.angle = 0;
            cat.size = 20;
            if (cat.sayTimer) clearTimeout(cat.sayTimer);
            if (cat.thinkTimer) clearTimeout(cat.thinkTimer);
            cat.sayText = '';
            cat.thinkText = '';
            drawCat();
        }

        // ---------- Definici√≥n de bloques Blockly ----------
        Blockly.Blocks['when_flag_clicked'] = {
            init: function() {
                this.appendDummyInput().appendField('‚öë al presionar bandera');
                this.appendStatementInput('DO').setCheck(null);
                this.setColour('#FFC107');
                this.setPreviousStatement(false);
                this.setNextStatement(false);
            }
        };

        Blockly.Blocks['when_key_pressed'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField('‚å®Ô∏è al presionar tecla')
                    .appendField(new Blockly.FieldDropdown([['espacio', 'Space'], ['flecha arriba', 'ArrowUp'], ['flecha abajo', 'ArrowDown'], ['flecha izquierda', 'ArrowLeft'], ['flecha derecha', 'ArrowRight'], ['a', 'KeyA'], ['b', 'KeyB']]), 'KEY');
                this.appendStatementInput('DO').setCheck(null);
                this.setColour('#FFC107');
                this.setPreviousStatement(false);
                this.setNextStatement(false);
            }
        };

        Blockly.Blocks['move_forward'] = {
            init: function() {
                this.appendDummyInput().appendField('üö∂ mover');
                this.appendValueInput('STEPS').setCheck('Number').appendField('pasos');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#4CAF50');
            }
        };

        Blockly.Blocks['move_backward'] = {
            init: function() {
                this.appendDummyInput().appendField('üîô mover atr√°s');
                this.appendValueInput('STEPS').setCheck('Number').appendField('pasos');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#4CAF50');
            }
        };

        Blockly.Blocks['turn_right'] = {
            init: function() {
                this.appendDummyInput().appendField('‚Üª girar derecha');
                this.appendValueInput('DEGREES').setCheck('Number').appendField('grados');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#4CAF50');
            }
        };

        Blockly.Blocks['turn_left'] = {
            init: function() {
                this.appendDummyInput().appendField('‚Ü∫ girar izquierda');
                this.appendValueInput('DEGREES').setCheck('Number').appendField('grados');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#4CAF50');
            }
        };

        Blockly.Blocks['go_to'] = {
            init: function() {
                this.appendDummyInput().appendField('üéØ ir a');
                this.appendValueInput('X').setCheck('Number').appendField('x');
                this.appendValueInput('Y').setCheck('Number').appendField('y');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#4CAF50');
            }
        };

        Blockly.Blocks['point_towards'] = {
            init: function() {
                this.appendDummyInput().appendField('üß≠ apuntar hacia');
                this.appendValueInput('X').setCheck('Number').appendField('x');
                this.appendValueInput('Y').setCheck('Number').appendField('y');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#4CAF50');
            }
        };

        Blockly.Blocks['say'] = {
            init: function() {
                this.appendDummyInput().appendField('üí¨ decir');
                this.appendValueInput('MESSAGE').setCheck('String').appendField('mensaje');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#9C27B0');
            }
        };

        Blockly.Blocks['think'] = {
            init: function() {
                this.appendDummyInput().appendField('ü§î pensar');
                this.appendValueInput('MESSAGE').setCheck('String').appendField('mensaje');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#9C27B0');
            }
        };

        Blockly.Blocks['set_color'] = {
            init: function() {
                this.appendDummyInput().appendField('üé® cambiar color a');
                this.appendValueInput('COLOR').setCheck('Colour').appendField('');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#9C27B0');
            }
        };

        Blockly.Blocks['change_size'] = {
            init: function() {
                this.appendDummyInput().appendField('üîç cambiar tama√±o a');
                this.appendValueInput('SIZE').setCheck('Number').appendField('');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#9C27B0');
            }
        };

        Blockly.Blocks['play_sound'] = {
            init: function() {
                this.appendDummyInput().appendField('üîä reproducir sonido');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#00BCD4');
            }
        };

        Blockly.Blocks['beep'] = {
            init: function() {
                this.appendDummyInput().appendField('üì¢ beep');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#00BCD4');
            }
        };

        Blockly.Blocks['repeat'] = {
            init: function() {
                this.appendDummyInput().appendField('üîÑ repetir');
                this.appendValueInput('TIMES').setCheck('Number').appendField('veces');
                this.appendStatementInput('DO').setCheck(null).appendField('hacer');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#FF5722');
            }
        };

        Blockly.Blocks['wait'] = {
            init: function() {
                this.appendDummyInput().appendField('‚è±Ô∏è esperar');
                this.appendValueInput('SECONDS').setCheck('Number').appendField('segundos');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#FF5722');
            }
        };

        Blockly.Blocks['if_then'] = {
            init: function() {
                this.appendDummyInput().appendField('üîÄ si');
                this.appendValueInput('CONDITION').setCheck('Boolean').appendField('condici√≥n');
                this.appendStatementInput('DO').setCheck(null).appendField('entonces');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#FF5722');
            }
        };

        // Generadores de c√≥digo
        Blockly.JavaScript['when_flag_clicked'] = function(block) {
            let statements = Blockly.JavaScript.statementToCode(block, 'DO');
            return '(function() {\n' + statements + '})();\n';
        };

        Blockly.JavaScript['when_key_pressed'] = function(block) {
            let key = block.getFieldValue('KEY');
            let statements = Blockly.JavaScript.statementToCode(block, 'DO');
            return `
                document.addEventListener('keydown', function(e) {
                    if(e.code === '${key}') {
                        (function() { ${statements} })();
                    }
                });
            `;
        };

        Blockly.JavaScript['move_forward'] = function(block) {
            let steps = Blockly.JavaScript.valueToCode(block, 'STEPS', Blockly.JavaScript.ORDER_NONE) || '10';
            return 'mover(' + steps + ');\n';
        };

        Blockly.JavaScript['move_backward'] = function(block) {
            let steps = Blockly.JavaScript.valueToCode(block, 'STEPS', Blockly.JavaScript.ORDER_NONE) || '10';
            return 'moverAtras(' + steps + ');\n';
        };

        Blockly.JavaScript['turn_right'] = function(block) {
            let degrees = Blockly.JavaScript.valueToCode(block, 'DEGREES', Blockly.JavaScript.ORDER_NONE) || '15';
            return 'girar(' + degrees + ');\n';
        };

        Blockly.JavaScript['turn_left'] = function(block) {
            let degrees = Blockly.JavaScript.valueToCode(block, 'DEGREES', Blockly.JavaScript.ORDER_NONE) || '15';
            return 'girarIzquierda(' + degrees + ');\n';
        };

        Blockly.JavaScript['go_to'] = function(block) {
            let x = Blockly.JavaScript.valueToCode(block, 'X', Blockly.JavaScript.ORDER_NONE) || '200';
            let y = Blockly.JavaScript.valueToCode(block, 'Y', Blockly.JavaScript.ORDER_NONE) || '200';
            return 'irA(' + x + ', ' + y + ');\n';
        };

        Blockly.JavaScript['point_towards'] = function(block) {
            let x = Blockly.JavaScript.valueToCode(block, 'X', Blockly.JavaScript.ORDER_NONE) || '200';
            let y = Blockly.JavaScript.valueToCode(block, 'Y', Blockly.JavaScript.ORDER_NONE) || '200';
            return 'apuntarHacia(' + x + ', ' + y + ');\n';
        };

        Blockly.JavaScript['say'] = function(block) {
            let message = Blockly.JavaScript.valueToCode(block, 'MESSAGE', Blockly.JavaScript.ORDER_NONE) || "'Hola'";
            return 'decir(' + message + ');\n';
        };

        Blockly.JavaScript['think'] = function(block) {
            let message = Blockly.JavaScript.valueToCode(block, 'MESSAGE', Blockly.JavaScript.ORDER_NONE) || "'...'";
            return 'pensar(' + message + ');\n';
        };

        Blockly.JavaScript['set_color'] = function(block) {
            let color = Blockly.JavaScript.valueToCode(block, 'COLOR', Blockly.JavaScript.ORDER_NONE) || "'#FF6B6B'";
            return 'cambiarColor(' + color + ');\n';
        };

        Blockly.JavaScript['change_size'] = function(block) {
            let size = Blockly.JavaScript.valueToCode(block, 'SIZE', Blockly.JavaScript.ORDER_NONE) || '20';
            return 'cambiarSize(' + size + ');\n';
        };

        Blockly.JavaScript['play_sound'] = function(block) {
            return 'playSound();\n';
        };

        Blockly.JavaScript['beep'] = function(block) {
            return 'beep();\n';
        };

        Blockly.JavaScript['repeat'] = function(block) {
            let times = Blockly.JavaScript.valueToCode(block, 'TIMES', Blockly.JavaScript.ORDER_ASSIGNMENT) || '10';
            let statements = Blockly.JavaScript.statementToCode(block, 'DO');
            return 'for (var i__ = 0; i__ < ' + times + '; i__++) {\n' + statements + '}\n';
        };

        Blockly.JavaScript['wait'] = function(block) {
            let seconds = Blockly.JavaScript.valueToCode(block, 'SECONDS', Blockly.JavaScript.ORDER_NONE) || '1';
            return 'await wait(' + seconds + ');\n';
        };

        Blockly.JavaScript['if_then'] = function(block) {
            let condition = Blockly.JavaScript.valueToCode(block, 'CONDITION', Blockly.JavaScript.ORDER_NONE) || 'true';
            let statements = Blockly.JavaScript.statementToCode(block, 'DO');
            return 'if (' + condition + ') {\n' + statements + '}\n';
        };

        // Inicializar Blockly
        const toolbox = document.getElementById('toolbox');
        const blocklyDiv = document.getElementById('blocklyDiv');
        const workspace = Blockly.inject(blocklyDiv, {
            toolbox: toolbox,
            trashcan: true,
            scrollbars: true,
            horizontalLayout: false,
            toolboxPosition: 'start',
            sounds: false,
            media: 'https://unpkg.com/blockly/media/'
        });

        // Bloques iniciales
        Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(
            '<xml>' +
            '<block type="when_flag_clicked" x="20" y="20"></block>' +
            '<block type="when_key_pressed" x="20" y="120"></block>' +
            '</xml>'
        ), workspace);

        // Botones
        document.getElementById('runButton').addEventListener('click', async function() {
            let code = Blockly.JavaScript.workspaceToCode(workspace);
            console.log("C√≥digo generado:\n", code);
            try {
                // Hacer que async/await funcione
                let func = new Function('mover', 'moverAtras', 'girar', 'girarIzquierda', 'irA', 'apuntarHacia', 'decir', 'pensar', 'cambiarColor', 'cambiarSize', 'playSound', 'beep', 'wait', `
                    return (async function() {
                        ${code}
                    })();
                `);
                await func(mover, moverAtras, girar, girarIzquierda, irA, apuntarHacia, decir, pensar, cambiarColor, cambiarSize, playSound, beep, wait);
            } catch (e) {
                alert("Error al ejecutar los bloques: " + e.message);
            }
        });

        document.getElementById('resetButton').addEventListener('click', resetCat);
        document.getElementById('clearButton').addEventListener('click', function() {
            workspace.clear();
            resetCat();
        });

        // Inicializar
        createPixelGrid();
        loadDefaultSprite();
        resetCat();

        window.addEventListener('resize', () => Blockly.svgResize(workspace));
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>RTS Pixel 2008 - Modding y Auras</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #222;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Courier New', monospace;
        }
        #gameContainer {
            background: #000;
            padding: 10px;
            border: 4px solid #555;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        canvas {
            display: block;
            width: 800px;
            height: 600px;
            border: 2px solid #777;
        }
        #ui {
            background: #333;
            color: #0f0;
            padding: 10px;
            border: 2px solid #555;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 16px;
            position: relative;
        }
        .ui-section {
            display: flex;
            gap: 10px;
            align-items: center;
            border-right: 2px solid #555;
            padding-right: 10px;
        }
        button {
            background: #444;
            color: #0f0;
            border: 2px solid #0f0;
            padding: 6px 12px;
            font-family: inherit;
            font-size: 16px;
            cursor: pointer;
            image-rendering: pixelated;
        }
        button:hover {
            background: #0f0;
            color: #000;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #info {
            margin-left: auto;
            display: flex;
            gap: 20px;
        }
        #modPanel {
            position: absolute;
            top: 60px;
            left: 10px;
            background: #222;
            border: 2px solid #0f0;
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
            color: #0f0;
            max-height: 500px;
            overflow-y: auto;
            width: 300px;
        }
        #modPanel h3 {
            margin: 5px 0;
        }
        #modPanel label {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            font-size: 14px;
        }
        #modPanel input, #modPanel select {
            width: 150px;
            background: #333;
            color: #0f0;
            border: 1px solid #0f0;
        }
        #modPanel .section {
            border-top: 1px solid #0f0;
            padding-top: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
<div id="gameContainer">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div id="ui">
        <div class="ui-section">
            <span>üå≤ Madera: <span id="wood">100</span></span>
            <span>üçñ Comida: <span id="food">50</span></span>
            <span>üë• Pob: <span id="population">0</span>/<span id="maxPop">10</span></span>
        </div>
        <div class="ui-section">
            <button id="buildHouse">üè† Casa (50 madera)</button>
            <button id="buildFarm">üåæ Granja (30 madera)</button>
            <button id="buildWall">üß± Muralla (60 madera)</button>
        </div>
        <div class="ui-section">
            <button id="spawnSoldier">‚öîÔ∏è Soldado (20 comida)</button>
            <button id="spawnArcher">üèπ Arquero (25 comida)</button>
            <button id="spawnPeasant">üë∑ Ciudadano (15 comida)</button>
        </div>
        <div class="ui-section">
            <button id="startWave">üî• Iniciar oleada</button>
            <button id="toggleMod">üéÆ Modding</button>
        </div>
        <div id="info">
            <span id="selectedInfo">Ninguno</span>
        </div>
    </div>
    <div id="modPanel">
        <h3>‚öôÔ∏è Ajustes globales</h3>
        <label>Costo soldado: <input type="range" id="modSoldierCost" min="5" max="50" value="20"> <span id="modSoldierCostVal">20</span></label>
        <label>Costo arquero: <input type="range" id="modArcherCost" min="5" max="50" value="25"> <span id="modArcherCostVal">25</span></label>
        <label>Costo ciudadano: <input type="range" id="modPeasantCost" min="5" max="50" value="15"> <span id="modPeasantCostVal">15</span></label>
        <label>Cooldown ataque (frames): <input type="range" id="modAttackCooldown" min="10" max="100" value="30"> <span id="modAttackCooldownVal">30</span></label>
        <label>Da√±o ataque: <input type="range" id="modAttackDamage" min="1" max="10" value="2"> <span id="modAttackDamageVal">2</span></label>
        <label>Velocidad movimiento: <input type="range" id="modSpeed" min="0.5" max="5" step="0.1" value="1.5"> <span id="modSpeedVal">1.5</span></label>
        <label>Producci√≥n granja (comida/seg): <input type="range" id="modFarmOutput" min="0" max="5" value="1"> <span id="modFarmOutputVal">1</span></label>

        <div class="section">
            <h3>üÜï Crear unidad personalizada</h3>
            <label>Tipo: 
                <select id="customUnitType">
                    <option value="soldier">Soldado</option>
                    <option value="archer">Arquero</option>
                    <option value="peasant">Ciudadano</option>
                </select>
            </label>
            <label>Bando: 
                <select id="customUnitTeam">
                    <option value="player">Jugador</option>
                    <option value="enemy">Enemigo</option>
                </select>
            </label>
            <label>Vida: <input type="number" id="customUnitHp" min="1" max="100" value="10"></label>
            <label>Ataque: <input type="number" id="customUnitAttack" min="1" max="20" value="2"></label>
            <label>Velocidad: <input type="number" id="customUnitSpeed" min="0.5" max="5" step="0.1" value="1.5"></label>
            <label>Rango: <input type="number" id="customUnitRange" min="20" max="200" value="30"></label>
            <button id="createCustomUnit">‚ú® Crear unidad</button>
        </div>

        <div class="section">
            <button id="applyMods">Aplicar cambios globales</button>
            <button id="resetGame">üîÑ Reiniciar partida</button>
        </div>
    </div>
</div>

<script>
    (function() {
        // Configuraci√≥n
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;

        // Tama√±o del mundo
        const WORLD_WIDTH = 2000;
        const WORLD_HEIGHT = 2000;
        const GRID_SIZE = 40;

        // C√°mara
        let cameraX = 0;
        let cameraY = 0;
        const CAMERA_SPEED = 10;

        // Recursos iniciales
        let wood = 100;
        let food = 50;

        // Par√°metros modificables (modding)
        let mod = {
            soldierCost: 20,
            archerCost: 25,
            peasantCost: 15,
            attackCooldown: 30,
            attackDamage: 2,
            moveSpeed: 1.5,
            farmOutput: 1
        };

        // Unidades y edificios
        let playerUnits = [];
        let enemyUnits = [];
        let houses = [];
        let farms = [];
        let walls = [];
        let trees = [];
        let blueprints = [];
        let projectiles = [];

        // Selecci√≥n
        let selectedUnit = null;
        let selectedHouse = null;

        // Modo construcci√≥n
        let buildMode = null;
        const buildCost = { house: 50, farm: 30, wall: 60 };
        const buildMaxHp = { house: 200, farm: 150, wall: 400 };

        // Poblaci√≥n m√°xima
        let maxPopulation = 10;

        // Frame counter
        let frame = 0;

        // L√≠mite de le√±adores por √°rbol
        const MAX_LUMBERJACKS_PER_TREE = 3;
        let treeLumberjackCount = new Map();

        // --- Clases ---
        class Unit {
            constructor(x, y, team, type = 'soldier', hp = 10, attack = mod.attackDamage, speed = mod.moveSpeed, range = null) {
                this.x = x;
                this.y = y;
                this.team = team;
                this.type = type;
                this.hp = hp;
                this.maxHp = hp;
                this.attack = attack;
                this.attackRange = range || (type === 'archer' ? 100 : 30);
                this.targetX = x;
                this.targetY = y;
                this.speed = speed;
                this.attackCooldown = 0;
                this.size = 14;

                // Profesiones
                this.profession = null; // 'lumberjack', 'farmer', 'builder'
                this.assignedTree = null;
                this.assignedFarm = null;
                this.assignedBlueprint = null;
                this.gatherCooldown = 0;
            }

            move() {
                if (this.attackCooldown > 0) this.attackCooldown--;
                if (this.gatherCooldown > 0) this.gatherCooldown--;

                if (this.type === 'peasant') {
                    if (this.profession === 'lumberjack' && this.assignedTree) {
                        this.handleLumberjack();
                        return;
                    } else if (this.profession === 'farmer' && this.assignedFarm) {
                        this.handleFarmer();
                        return;
                    } else if (this.profession === 'builder' && this.assignedBlueprint) {
                        this.handleBuilder();
                        return;
                    }
                }

                this.moveToTarget();
            }

            moveToTarget() {
                const dx = this.targetX - this.x;
                const dy = this.targetY - this.y;
                const dist = Math.hypot(dx, dy);
                if (dist > 1) {
                    const moveX = (dx / dist) * this.speed;
                    const moveY = (dy / dist) * this.speed;
                    this.x += moveX;
                    this.y += moveY;
                }
                this.x = Math.max(10, Math.min(WORLD_WIDTH - 10, this.x));
                this.y = Math.max(10, Math.min(WORLD_HEIGHT - 10, this.y));
            }

            handleLumberjack() {
                if (!trees.includes(this.assignedTree)) {
                    this.findNewTree();
                    if (!this.assignedTree) {
                        this.profession = null;
                        return;
                    }
                }

                const tree = this.assignedTree;
                const dx = tree.x - this.x;
                const dy = tree.y - this.y;
                const dist = Math.hypot(dx, dy);

                if (dist < 30) {
                    if (this.gatherCooldown <= 0) {
                        tree.hp -= 3;
                        this.gatherCooldown = 20;
                        if (tree.hp <= 0) {
                            wood += tree.woodAmount;
                            treeLumberjackCount.delete(tree);
                            trees = trees.filter(t => t !== tree);
                            this.assignedTree = null;
                            this.findNewTree();
                            if (!this.assignedTree) {
                                this.profession = null;
                            }
                        }
                    }
                } else {
                    this.targetX = tree.x;
                    this.targetY = tree.y;
                    this.moveToTarget();
                }
            }

            findNewTree() {
                if (this.assignedTree) {
                    const oldCount = treeLumberjackCount.get(this.assignedTree) || 0;
                    treeLumberjackCount.set(this.assignedTree, Math.max(0, oldCount - 1));
                }
                let bestTree = null;
                let bestDist = Infinity;
                for (let tree of trees) {
                    const count = treeLumberjackCount.get(tree) || 0;
                    if (count < MAX_LUMBERJACKS_PER_TREE) {
                        const dist = Math.hypot(this.x - tree.x, this.y - tree.y);
                        if (dist < bestDist) {
                            bestDist = dist;
                            bestTree = tree;
                        }
                    }
                }
                if (bestTree) {
                    this.assignedTree = bestTree;
                    const newCount = (treeLumberjackCount.get(bestTree) || 0) + 1;
                    treeLumberjackCount.set(bestTree, newCount);
                }
            }

            handleFarmer() {
                if (!farms.includes(this.assignedFarm)) {
                    this.profession = null;
                    this.assignedFarm = null;
                    return;
                }
                const farm = this.assignedFarm;
                const dx = farm.x - this.x;
                const dy = farm.y - this.y;
                const dist = Math.hypot(dx, dy);
                if (dist > 20) {
                    this.targetX = farm.x;
                    this.targetY = farm.y;
                    this.moveToTarget();
                }
            }

            handleBuilder() {
                const bp = this.assignedBlueprint;
                if (!blueprints.includes(bp)) {
                    this.profession = null;
                    this.assignedBlueprint = null;
                    return;
                }
                const dx = bp.x - this.x;
                const dy = bp.y - this.y;
                const dist = Math.hypot(dx, dy);
                if (dist < 30) {
                    if (this.gatherCooldown <= 0) {
                        bp.hp += 5;
                        this.gatherCooldown = 10;
                        if (bp.hp >= bp.maxHp) {
                            bp.hp = bp.maxHp;
                            if (bp.type === 'house') {
                                houses.push(new Building(bp.x, bp.y, 'house'));
                            } else if (bp.type === 'farm') {
                                farms.push(new Building(bp.x, bp.y, 'farm'));
                            } else if (bp.type === 'wall') {
                                walls.push(new Building(bp.x, bp.y, 'wall'));
                            }
                            blueprints = blueprints.filter(b => b !== bp);
                            this.assignedBlueprint = null;
                            this.profession = null;
                        }
                    }
                } else {
                    this.targetX = bp.x;
                    this.targetY = bp.y;
                    this.moveToTarget();
                }
            }

            attackUnit(target) {
                if (this.attackCooldown <= 0) {
                    if (this.type === 'archer') {
                        projectiles.push(new Projectile(this.x, this.y, target, this.attack));
                        this.attackCooldown = mod.attackCooldown * 1.3;
                    } else {
                        target.hp -= this.attack;
                        this.attackCooldown = mod.attackCooldown;
                    }
                }
            }

            draw(ctx, camX, camY) {
                const screenX = this.x - camX;
                const screenY = this.y - camY;
                if (screenX < -20 || screenX > canvas.width + 20 || screenY < -20 || screenY > canvas.height + 20) return;

                // Color seg√∫n equipo y tipo
                if (this.team === 'player') {
                    if (this.type === 'soldier') ctx.fillStyle = '#44f';
                    else if (this.type === 'archer') ctx.fillStyle = '#8a2be2';
                    else ctx.fillStyle = '#2e8b57';
                } else {
                    ctx.fillStyle = '#f44';
                }

                // Dibujar cuerpo
                ctx.fillRect(screenX - this.size/2, screenY - this.size/2, this.size, this.size);

                // Icono de profesi√≥n para ciudadanos
                if (this.type === 'peasant' && this.profession) {
                    ctx.fillStyle = '#ff0';
                    ctx.font = '12px monospace';
                    if (this.profession === 'lumberjack') ctx.fillText('üå≤', screenX - 5, screenY - 15);
                    else if (this.profession === 'farmer') ctx.fillText('üåæ', screenX - 5, screenY - 15);
                    else if (this.profession === 'builder') ctx.fillText('üî®', screenX - 5, screenY - 15);
                }

                // Barra de vida
                const hpPercent = this.hp / this.maxHp;
                ctx.fillStyle = '#0f0';
                ctx.fillRect(screenX - this.size/2, screenY - this.size/2 - 5, this.size * hpPercent, 2);
                ctx.fillStyle = '#f00';
                ctx.fillRect(screenX - this.size/2 + this.size * hpPercent, screenY - this.size/2 - 5, this.size * (1 - hpPercent), 2);

                // Aura de selecci√≥n (c√≠rculo brillante y cubo encima)
                if (selectedUnit === this || selectedHouse === this) {
                    // Cubo encima
                    ctx.fillStyle = '#ff0';
                    ctx.fillRect(screenX - 3, screenY - this.size/2 - 12, 6, 6);
                    
                    // Aura (c√≠rculo semitransparente)
                    ctx.strokeStyle = '#ff0';
                    ctx.lineWidth = 2;
                    ctx.globalAlpha = 0.6;
                    ctx.beginPath();
                    ctx.arc(screenX, screenY, this.size/2 + 8, 0, 2 * Math.PI);
                    ctx.stroke();
                    ctx.globalAlpha = 1.0;
                }
            }
        }

        class Building {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.width = 40;
                this.height = 40;
                this.team = 'player';
                if (type === 'wall') {
                    this.maxHp = 400;
                    this.hp = 400;
                } else {
                    this.maxHp = 200;
                    this.hp = 200;
                }
            }

            draw(ctx, camX, camY) {
                const screenX = this.x - camX;
                const screenY = this.y - camY;
                if (screenX < -this.width || screenX > canvas.width + this.width || screenY < -this.height || screenY > canvas.height + this.height) return;

                if (this.type === 'house') {
                    ctx.fillStyle = '#a52a2a';
                    ctx.fillRect(screenX - this.width/2, screenY - this.height/2, this.width, this.height);
                    ctx.fillStyle = '#8b4513';
                    ctx.beginPath();
                    ctx.moveTo(screenX - this.width/2, screenY - this.height/2);
                    ctx.lineTo(screenX + this.width/2, screenY - this.height/2);
                    ctx.lineTo(screenX, screenY - this.height/2 - 15);
                    ctx.closePath();
                    ctx.fill();
                    ctx.fillStyle = '#654321';
                    ctx.fillRect(screenX - 8, screenY + 5, 16, 20);
                } else if (this.type === 'farm') {
                    ctx.fillStyle = '#7cfc00';
                    ctx.fillRect(screenX - this.width/2, screenY - this.height/2, this.width, this.height);
                    ctx.fillStyle = '#ff0';
                    for (let i = -1; i <= 1; i++) {
                        for (let j = -1; j <= 1; j++) {
                            ctx.fillRect(screenX + i*10 - 5, screenY + j*10 - 5, 6, 6);
                        }
                    }
                } else if (this.type === 'wall') {
                    ctx.fillStyle = '#888';
                    ctx.fillRect(screenX - this.width/2, screenY - this.height/2, this.width, this.height);
                    ctx.fillStyle = '#aaa';
                    ctx.fillRect(screenX - this.width/2 + 5, screenY - this.height/2 + 5, this.width - 10, this.height - 10);
                }

                if (this.hp < this.maxHp) {
                    const hpPercent = this.hp / this.maxHp;
                    ctx.fillStyle = '#0f0';
                    ctx.fillRect(screenX - this.width/2, screenY - this.height/2 - 10, this.width * hpPercent, 3);
                    ctx.fillStyle = '#f00';
                    ctx.fillRect(screenX - this.width/2 + this.width * hpPercent, screenY - this.height/2 - 10, this.width * (1 - hpPercent), 3);
                }

                // Aura de selecci√≥n para casas
                if (selectedHouse === this) {
                    ctx.fillStyle = '#ff0';
                    ctx.fillRect(screenX - 3, screenY - this.height/2 - 12, 6, 6);
                    ctx.strokeStyle = '#ff0';
                    ctx.lineWidth = 2;
                    ctx.globalAlpha = 0.6;
                    ctx.beginPath();
                    ctx.arc(screenX, screenY, this.width/2 + 8, 0, 2 * Math.PI);
                    ctx.stroke();
                    ctx.globalAlpha = 1.0;
                }
            }
        }

        class Blueprint {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.width = 40;
                this.height = 40;
                this.hp = 0;
                this.maxHp = buildMaxHp[type];
                this.team = 'player';
            }

            draw(ctx, camX, camY) {
                const screenX = this.x - camX;
                const screenY = this.y - camY;
                if (screenX < -this.width || screenX > canvas.width + this.width || screenY < -this.height || screenY > canvas.height + this.height) return;

                ctx.fillStyle = '#fff';
                ctx.globalAlpha = 0.5;
                ctx.fillRect(screenX - this.width/2, screenY - this.height/2, this.width, this.height);
                ctx.globalAlpha = 1.0;
                ctx.strokeStyle = '#ff0';
                ctx.lineWidth = 2;
                ctx.strokeRect(screenX - this.width/2, screenY - this.height/2, this.width, this.height);

                const progress = this.hp / this.maxHp;
                ctx.fillStyle = '#0f0';
                ctx.fillRect(screenX - this.width/2, screenY - this.height/2 - 10, this.width * progress, 4);
            }
        }

        class Tree {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.hp = 30;
                this.woodAmount = 15;
                this.size = 20;
            }

            draw(ctx, camX, camY) {
                const screenX = this.x - camX;
                const screenY = this.y - camY;
                if (screenX < -this.size || screenX > canvas.width + this.size || screenY < -this.size || screenY > canvas.height + this.size) return;

                ctx.fillStyle = '#0a0';
                ctx.fillRect(screenX - 10, screenY - 15, 20, 30);
                ctx.fillStyle = '#3a5';
                ctx.fillRect(screenX - 15, screenY - 25, 30, 15);
            }
        }

        class Projectile {
            constructor(x, y, target, damage) {
                this.x = x;
                this.y = y;
                this.target = target;
                this.damage = damage;
                this.speed = 5;
                this.active = true;
            }

            update() {
                if (!this.target || this.target.hp <= 0) {
                    this.active = false;
                    return;
                }
                const dx = this.target.x - this.x;
                const dy = this.target.y - this.y;
                const dist = Math.hypot(dx, dy);
                if (dist < this.speed) {
                    this.target.hp -= this.damage;
                    this.active = false;
                } else {
                    this.x += (dx / dist) * this.speed;
                    this.y += (dy / dist) * this.speed;
                }
            }

            draw(ctx, camX, camY) {
                const screenX = this.x - camX;
                const screenY = this.y - camY;
                if (screenX < 0 || screenX > canvas.width || screenY < 0 || screenY > canvas.height) return;
                ctx.fillStyle = '#ff0';
                ctx.fillRect(screenX - 2, screenY - 2, 4, 4);
            }
        }

        // --- Inicializaci√≥n ---
        function initGame() {
            // Limpiar todo
            playerUnits = [];
            enemyUnits = [];
            houses = [];
            farms = [];
            walls = [];
            trees = [];
            blueprints = [];
            projectiles = [];
            treeLumberjackCount.clear();

            // Crear √°rboles
            for (let i = 0; i < 30; i++) {
                trees.push(new Tree(
                    200 + Math.random() * 1600,
                    200 + Math.random() * 1600
                ));
            }

            // Unidades iniciales del jugador
            playerUnits.push(new Unit(500, 500, 'player', 'soldier', 10, mod.attackDamage, mod.moveSpeed));
            playerUnits.push(new Unit(550, 500, 'player', 'peasant', 10, 0, mod.moveSpeed));
            playerUnits.push(new Unit(600, 500, 'player', 'peasant', 10, 0, mod.moveSpeed));

            // Casa inicial
            houses.push(new Building(800, 500, 'house'));
            updateMaxPopulation();

            // Algunos enemigos para probar
            enemyUnits.push(new Unit(1500, 500, 'enemy', 'soldier', 10, mod.attackDamage, mod.moveSpeed));
            enemyUnits.push(new Unit(1550, 500, 'enemy', 'soldier', 10, mod.attackDamage, mod.moveSpeed));

            // Recursos
            wood = 100;
            food = 50;
        }

        // --- Funciones auxiliares ---
        function updateMaxPopulation() {
            maxPopulation = 10 + houses.length * 5;
            document.getElementById('maxPop').innerText = maxPopulation;
        }

        function updateUI() {
            document.getElementById('wood').innerText = wood;
            document.getElementById('food').innerText = food;
            document.getElementById('population').innerText = playerUnits.length;
            document.getElementById('maxPop').innerText = maxPopulation;
            if (selectedUnit) {
                let info = `${selectedUnit.team} ${selectedUnit.type}`;
                if (selectedUnit.type === 'peasant' && selectedUnit.profession) {
                    info += ` (${selectedUnit.profession})`;
                }
                document.getElementById('selectedInfo').innerText = info;
            } else if (selectedHouse) {
                document.getElementById('selectedInfo').innerText = 'Casa seleccionada';
            } else {
                document.getElementById('selectedInfo').innerText = 'Ninguno';
            }
        }

        function snapToGrid(x, y) {
            return {
                x: Math.round(x / GRID_SIZE) * GRID_SIZE,
                y: Math.round(y / GRID_SIZE) * GRID_SIZE
            };
        }

        function isPositionFree(x, y) {
            if (x < GRID_SIZE/2 || x > WORLD_WIDTH - GRID_SIZE/2 || y < GRID_SIZE/2 || y > WORLD_HEIGHT - GRID_SIZE/2) return false;
            for (let b of [...houses, ...farms, ...walls]) {
                if (Math.hypot(x - b.x, y - b.y) < GRID_SIZE) return false;
            }
            for (let bp of blueprints) {
                if (Math.hypot(x - bp.x, y - bp.y) < GRID_SIZE) return false;
            }
            for (let t of trees) {
                if (Math.hypot(x - t.x, y - t.y) < GRID_SIZE) return false;
            }
            return true;
        }

        function startWave() {
            const count = 5 + Math.floor(Math.random() * 5);
            for (let i = 0; i < count; i++) {
                let x, y;
                if (Math.random() < 0.5) {
                    x = Math.random() < 0.5 ? 50 : WORLD_WIDTH - 50;
                    y = 100 + Math.random() * (WORLD_HEIGHT - 200);
                } else {
                    x = 100 + Math.random() * (WORLD_WIDTH - 200);
                    y = Math.random() < 0.5 ? 50 : WORLD_HEIGHT - 50;
                }
                enemyUnits.push(new Unit(x, y, 'enemy', 'soldier', 10, mod.attackDamage, mod.moveSpeed));
            }
        }

        // --- IA enemiga ---
        function enemyAI() {
            for (let enemy of enemyUnits) {
                if (playerUnits.length === 0) break;
                let closest = null;
                let closestDist = Infinity;
                for (let player of playerUnits) {
                    const dist = Math.hypot(enemy.x - player.x, enemy.y - player.y);
                    if (dist < closestDist) {
                        closestDist = dist;
                        closest = player;
                    }
                }
                if (closest) {
                    if (closestDist < enemy.attackRange) {
                        enemy.attackUnit(closest);
                    } else {
                        enemy.targetX = closest.x;
                        enemy.targetY = closest.y;
                    }
                }
                enemy.move();
            }
        }

        // --- Combate ---
        function resolveCombat() {
            for (let player of playerUnits) {
                for (let enemy of enemyUnits) {
                    const dist = Math.hypot(player.x - enemy.x, player.y - enemy.y);
                    if (dist < player.attackRange) {
                        player.attackUnit(enemy);
                    }
                }
            }
            playerUnits = playerUnits.filter(u => u.hp > 0);
            enemyUnits = enemyUnits.filter(u => u.hp > 0);
        }

        // --- Producci√≥n de granjas ---
        function updateFarms() {
            for (let farm of farms) {
                const hasFarmer = playerUnits.some(u => u.type === 'peasant' && u.profession === 'farmer' && u.assignedFarm === farm);
                if (hasFarmer) {
                    food += mod.farmOutput;
                }
            }
        }

        // --- Proyectiles ---
        function updateProjectiles() {
            for (let i = projectiles.length - 1; i >= 0; i--) {
                projectiles[i].update();
                if (!projectiles[i].active) projectiles.splice(i, 1);
            }
        }

        // --- Dibujado ---
        function drawBackground(camX, camY) {
            ctx.fillStyle = '#1a3a1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#2a4a2a';
            ctx.lineWidth = 1;
            const startX = Math.floor(camX / GRID_SIZE) * GRID_SIZE;
            const startY = Math.floor(camY / GRID_SIZE) * GRID_SIZE;
            for (let x = startX; x < camX + canvas.width; x += GRID_SIZE) {
                ctx.beginPath();
                ctx.moveTo(x - camX, 0);
                ctx.lineTo(x - camX, canvas.height);
                ctx.stroke();
            }
            for (let y = startY; y < camY + canvas.height; y += GRID_SIZE) {
                ctx.beginPath();
                ctx.moveTo(0, y - camY);
                ctx.lineTo(canvas.width, y - camY);
                ctx.stroke();
            }
        }

        // --- Eventos de teclado para c√°mara ---
        const keys = {};
        window.addEventListener('keydown', (e) => keys[e.key] = true);
        window.addEventListener('keyup', (e) => keys[e.key] = false);

        function handleCamera() {
            if (keys['ArrowUp']) cameraY = Math.max(0, cameraY - CAMERA_SPEED);
            if (keys['ArrowDown']) cameraY = Math.min(WORLD_HEIGHT - canvas.height, cameraY + CAMERA_SPEED);
            if (keys['ArrowLeft']) cameraX = Math.max(0, cameraX - CAMERA_SPEED);
            if (keys['ArrowRight']) cameraX = Math.min(WORLD_WIDTH - canvas.width, cameraX + CAMERA_SPEED);
        }

        // --- Eventos de rat√≥n ---
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const mouseX = (e.clientX - rect.left) * scaleX;
            const mouseY = (e.clientY - rect.top) * scaleY;
            const worldX = mouseX + cameraX;
            const worldY = mouseY + cameraY;

            if (e.button === 0) { // Izquierdo
                // Modo construcci√≥n
                if (buildMode) {
                    const cost = buildCost[buildMode];
                    if (wood >= cost) {
                        const { x: gridX, y: gridY } = snapToGrid(worldX, worldY);
                        if (isPositionFree(gridX, gridY)) {
                            blueprints.push(new Blueprint(gridX, gridY, buildMode));
                            wood -= cost;
                            buildMode = null;
                            updateUI();
                        } else {
                            alert('No se puede construir aqu√≠');
                        }
                    } else {
                        alert('Madera insuficiente');
                        buildMode = null;
                    }
                    return;
                }

                // Seleccionar unidades propias
                let clicked = null;
                for (let unit of playerUnits) {
                    const dist = Math.hypot(worldX - unit.x, worldY - unit.y);
                    if (dist < unit.size) {
                        clicked = unit;
                        break;
                    }
                }
                if (clicked) {
                    selectedUnit = clicked;
                    selectedHouse = null;
                    updateUI();
                    return;
                }

                // Seleccionar casas
                for (let house of houses) {
                    const dist = Math.hypot(worldX - house.x, worldY - house.y);
                    if (dist < house.width/2) {
                        selectedHouse = house;
                        selectedUnit = null;
                        updateUI();
                        return;
                    }
                }

                // Si hay un ciudadano seleccionado y no tiene profesi√≥n, asignar seg√∫n lo clickeado
                if (selectedUnit && selectedUnit.type === 'peasant' && selectedUnit.profession === null) {
                    // √Årbol
                    for (let tree of trees) {
                        const dist = Math.hypot(worldX - tree.x, worldY - tree.y);
                        if (dist < 20) {
                            const count = treeLumberjackCount.get(tree) || 0;
                            if (count < MAX_LUMBERJACKS_PER_TREE) {
                                selectedUnit.profession = 'lumberjack';
                                selectedUnit.assignedTree = tree;
                                treeLumberjackCount.set(tree, count + 1);
                                selectedUnit.targetX = selectedUnit.x;
                                updateUI();
                            } else {
                                alert('Este √°rbol ya tiene 3 le√±adores');
                            }
                            return;
                        }
                    }
                    // Granja
                    for (let farm of farms) {
                        const dist = Math.hypot(worldX - farm.x, worldY - farm.y);
                        if (dist < 20) {
                            selectedUnit.profession = 'farmer';
                            selectedUnit.assignedFarm = farm;
                            selectedUnit.targetX = selectedUnit.x;
                            updateUI();
                            return;
                        }
                    }
                    // Blueprint
                    for (let bp of blueprints) {
                        const dist = Math.hypot(worldX - bp.x, worldY - bp.y);
                        if (dist < 20) {
                            selectedUnit.profession = 'builder';
                            selectedUnit.assignedBlueprint = bp;
                            selectedUnit.targetX = selectedUnit.x;
                            updateUI();
                            return;
                        }
                    }
                }

                // Si no se clicke√≥ nada, deseleccionar
                selectedUnit = null;
                selectedHouse = null;
                updateUI();

            } else if (e.button === 2) { // Derecho
                e.preventDefault();
                if (selectedUnit) {
                    // Si es ciudadano con profesi√≥n, cancelar
                    if (selectedUnit.type === 'peasant' && selectedUnit.profession) {
                        if (selectedUnit.profession === 'lumberjack' && selectedUnit.assignedTree) {
                            const count = treeLumberjackCount.get(selectedUnit.assignedTree) || 0;
                            treeLumberjackCount.set(selectedUnit.assignedTree, Math.max(0, count - 1));
                        }
                        selectedUnit.profession = null;
                        selectedUnit.assignedTree = null;
                        selectedUnit.assignedFarm = null;
                        selectedUnit.assignedBlueprint = null;
                    }
                    selectedUnit.targetX = worldX;
                    selectedUnit.targetY = worldY;
                }
            }
        });

        canvas.addEventListener('contextmenu', (e) => e.preventDefault());

        // --- Botones UI ---
        document.getElementById('buildHouse').addEventListener('click', () => buildMode = 'house');
        document.getElementById('buildFarm').addEventListener('click', () => buildMode = 'farm');
        document.getElementById('buildWall').addEventListener('click', () => buildMode = 'wall');

        document.getElementById('spawnSoldier').addEventListener('click', () => {
            if (!selectedHouse) { alert('Selecciona una casa'); return; }
            if (food < mod.soldierCost) { alert('Comida insuficiente'); return; }
            if (playerUnits.length >= maxPopulation) { alert('L√≠mite de poblaci√≥n'); return; }
            food -= mod.soldierCost;
            const angle = Math.random() * 2 * Math.PI;
            const x = selectedHouse.x + Math.cos(angle) * 50;
            const y = selectedHouse.y + Math.sin(angle) * 50;
            playerUnits.push(new Unit(x, y, 'player', 'soldier', 10, mod.attackDamage, mod.moveSpeed));
            updateUI();
        });

        document.getElementById('spawnArcher').addEventListener('click', () => {
            if (!selectedHouse) { alert('Selecciona una casa'); return; }
            if (food < mod.archerCost) { alert('Comida insuficiente'); return; }
            if (playerUnits.length >= maxPopulation) { alert('L√≠mite de poblaci√≥n'); return; }
            food -= mod.archerCost;
            const angle = Math.random() * 2 * Math.PI;
            const x = selectedHouse.x + Math.cos(angle) * 50;
            const y = selectedHouse.y + Math.sin(angle) * 50;
            playerUnits.push(new Unit(x, y, 'player', 'archer', 8, mod.attackDamage, mod.moveSpeed, 100));
            updateUI();
        });

        document.getElementById('spawnPeasant').addEventListener('click', () => {
            if (!selectedHouse) { alert('Selecciona una casa'); return; }
            if (food < mod.peasantCost) { alert('Comida insuficiente'); return; }
            if (playerUnits.length >= maxPopulation) { alert('L√≠mite de poblaci√≥n'); return; }
            food -= mod.peasantCost;
            const angle = Math.random() * 2 * Math.PI;
            const x = selectedHouse.x + Math.cos(angle) * 50;
            const y = selectedHouse.y + Math.sin(angle) * 50;
            playerUnits.push(new Unit(x, y, 'player', 'peasant', 8, 0, mod.moveSpeed));
            updateUI();
        });

        document.getElementById('startWave').addEventListener('click', startWave);

        // --- Modding panel ---
        const modPanel = document.getElementById('modPanel');
        document.getElementById('toggleMod').addEventListener('click', () => {
            modPanel.style.display = modPanel.style.display === 'flex' ? 'none' : 'flex';
        });

        // Sliders globales
        const modSoldierCost = document.getElementById('modSoldierCost');
        const modArcherCost = document.getElementById('modArcherCost');
        const modPeasantCost = document.getElementById('modPeasantCost');
        const modAttackCooldown = document.getElementById('modAttackCooldown');
        const modAttackDamage = document.getElementById('modAttackDamage');
        const modSpeed = document.getElementById('modSpeed');
        const modFarmOutput = document.getElementById('modFarmOutput');

        const modSoldierCostVal = document.getElementById('modSoldierCostVal');
        const modArcherCostVal = document.getElementById('modArcherCostVal');
        const modPeasantCostVal = document.getElementById('modPeasantCostVal');
        const modAttackCooldownVal = document.getElementById('modAttackCooldownVal');
        const modAttackDamageVal = document.getElementById('modAttackDamageVal');
        const modSpeedVal = document.getElementById('modSpeedVal');
        const modFarmOutputVal = document.getElementById('modFarmOutputVal');

        function updateModDisplay() {
            modSoldierCostVal.innerText = modSoldierCost.value;
            modArcherCostVal.innerText = modArcherCost.value;
            modPeasantCostVal.innerText = modPeasantCost.value;
            modAttackCooldownVal.innerText = modAttackCooldown.value;
            modAttackDamageVal.innerText = modAttackDamage.value;
            modSpeedVal.innerText = modSpeed.value;
            modFarmOutputVal.innerText = modFarmOutput.value;
        }

        modSoldierCost.addEventListener('input', updateModDisplay);
        modArcherCost.addEventListener('input', updateModDisplay);
        modPeasantCost.addEventListener('input', updateModDisplay);
        modAttackCooldown.addEventListener('input', updateModDisplay);
        modAttackDamage.addEventListener('input', updateModDisplay);
        modSpeed.addEventListener('input', updateModDisplay);
        modFarmOutput.addEventListener('input', updateModDisplay);

        document.getElementById('applyMods').addEventListener('click', () => {
            mod.soldierCost = parseInt(modSoldierCost.value);
            mod.archerCost = parseInt(modArcherCost.value);
            mod.peasantCost = parseInt(modPeasantCost.value);
            mod.attackCooldown = parseInt(modAttackCooldown.value);
            mod.attackDamage = parseInt(modAttackDamage.value);
            mod.moveSpeed = parseFloat(modSpeed.value);
            mod.farmOutput = parseInt(modFarmOutput.value);

            // Actualizar unidades existentes
            for (let unit of playerUnits) {
                unit.speed = mod.moveSpeed;
                unit.attack = mod.attackDamage;
            }
            for (let unit of enemyUnits) {
                unit.speed = mod.moveSpeed;
                unit.attack = mod.attackDamage;
            }
            updateUI();
        });

        // Crear unidad personalizada
        document.getElementById('createCustomUnit').addEventListener('click', () => {
            const type = document.getElementById('customUnitType').value;
            const team = document.getElementById('customUnitTeam').value;
            const hp = parseInt(document.getElementById('customUnitHp').value);
            const attack = parseInt(document.getElementById('customUnitAttack').value);
            const speed = parseFloat(document.getElementById('customUnitSpeed').value);
            const range = parseInt(document.getElementById('customUnitRange').value);

            let x, y;
            if (team === 'player') {
                // Cerca del centro
                x = 800 + Math.random() * 200;
                y = 500 + Math.random() * 200;
            } else {
                // En los bordes
                if (Math.random() < 0.5) {
                    x = Math.random() < 0.5 ? 50 : WORLD_WIDTH - 50;
                    y = 100 + Math.random() * (WORLD_HEIGHT - 200);
                } else {
                    x = 100 + Math.random() * (WORLD_WIDTH - 200);
                    y = Math.random() < 0.5 ? 50 : WORLD_HEIGHT - 50;
                }
            }

            const newUnit = new Unit(x, y, team, type, hp, attack, speed, range);
            if (team === 'player') {
                if (playerUnits.length < maxPopulation || type === 'peasant') { // Los ciudadanos tambi√©n cuentan poblaci√≥n
                    playerUnits.push(newUnit);
                } else {
                    alert('L√≠mite de poblaci√≥n alcanzado');
                }
            } else {
                enemyUnits.push(newUnit);
            }
            updateUI();
        });

        // Reiniciar partida
        document.getElementById('resetGame').addEventListener('click', () => {
            // Aplicar mods primero
            mod.soldierCost = parseInt(modSoldierCost.value);
            mod.archerCost = parseInt(modArcherCost.value);
            mod.peasantCost = parseInt(modPeasantCost.value);
            mod.attackCooldown = parseInt(modAttackCooldown.value);
            mod.attackDamage = parseInt(modAttackDamage.value);
            mod.moveSpeed = parseFloat(modSpeed.value);
            mod.farmOutput = parseInt(modFarmOutput.value);

            initGame();
            selectedUnit = null;
            selectedHouse = null;
            buildMode = null;
            updateUI();
        });

        // --- Bucle principal ---
        function gameLoop() {
            frame++;

            handleCamera();

            enemyAI();

            for (let unit of playerUnits) {
                unit.move();
            }

            if (frame % 60 === 0) {
                updateFarms();
            }

            updateProjectiles();
            resolveCombat();
            updateUI();

            drawBackground(cameraX, cameraY);
            for (let tree of trees) tree.draw(ctx, cameraX, cameraY);
            for (let house of houses) house.draw(ctx, cameraX, cameraY);
            for (let farm of farms) farm.draw(ctx, cameraX, cameraY);
            for (let wall of walls) wall.draw(ctx, cameraX, cameraY);
            for (let bp of blueprints) bp.draw(ctx, cameraX, cameraY);
            for (let enemy of enemyUnits) enemy.draw(ctx, cameraX, cameraY);
            for (let player of playerUnits) player.draw(ctx, cameraX, cameraY);
            for (let proj of projectiles) proj.draw(ctx, cameraX, cameraY);

            if (buildMode) {
                ctx.fillStyle = '#fff';
                ctx.font = '20px monospace';
                ctx.fillText(`Construyendo ${buildMode} - haz clic en el mapa`, 10, 30);
            }

            requestAnimationFrame(gameLoop);
        }

        initGame();
        gameLoop();
    })();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>BlockPlay - Crea juegos con bloques (estilo Scratch)</title>
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f0f0f0;
        }
        header {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        header h1 {
            margin: 0;
            font-size: 1.8rem;
        }
        .btn {
            background-color: white;
            color: #4CAF50;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.2s;
            box-shadow: 0 2px 3px rgba(0,0,0,0.1);
        }
        .btn:hover {
            background-color: #e8e8e8;
            transform: scale(1.02);
        }
        .btn.danger {
            background-color: #f44336;
            color: white;
        }
        .btn.danger:hover {
            background-color: #d32f2f;
        }
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .blockly-area {
            width: 50%;
            border-right: 2px solid #ccc;
            background-color: #fafafa;
            display: flex;
            flex-direction: column;
        }
        .blockly-header {
            padding: 8px;
            background-color: #ddd;
            font-weight: bold;
            text-align: center;
        }
        #blocklyDiv {
            flex: 1;
            height: 100%;
            min-height: 500px;
        }
        .canvas-area {
            width: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #e5e5e5;
            padding: 10px;
        }
        canvas {
            background-color: white;
            border: 3px solid #333;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 500px;
            height: auto;
            aspect-ratio: 1/1;
        }
        .info {
            margin-top: 10px;
            font-size: 1.1rem;
            background: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #messageBox {
            color: #333;
            font-weight: bold;
            min-height: 1.5em;
        }
    </style>
    <!-- Cargar Blockly desde CDN -->
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
</head>
<body>
    <header>
        <h1>üß© BlockPlay ¬∑ Crea tu juego con bloques</h1>
        <button class="btn" id="runButton">‚ñ∂ Ejecutar programa</button>
        <button class="btn" id="resetButton">‚Ü∫ Reiniciar gato</button>
        <button class="btn danger" id="clearButton">üóë Limpiar bloques</button>
    </header>
    <div class="main-container">
        <div class="blockly-area">
            <div class="blockly-header">üß± √Årea de bloques (arrastra desde la caja de herramientas)</div>
            <div id="blocklyDiv"></div>
        </div>
        <div class="canvas-area">
            <canvas id="gameCanvas" width="400" height="400"></canvas>
            <div class="info">
                <span>üê± Posici√≥n: (<span id="posX">200</span>, <span id="posY">200</span>) | Direcci√≥n: <span id="angle">0</span>¬∞</span>
            </div>
            <div id="messageBox" class="info">üí¨ Mensaje: </div>
        </div>
    </div>

    <!-- Toolbox personalizada (caja de herramientas con nuestros bloques) -->
    <xml id="toolbox" style="display: none">
        <category name="Eventos" colour="#FFC107">
            <block type="when_flag_clicked"></block>
        </category>
        <category name="Movimiento" colour="#4CAF50">
            <block type="move_forward">
                <value name="STEPS">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
            <block type="turn_right">
                <value name="DEGREES">
                    <shadow type="math_number">
                        <field name="NUM">15</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category name="Apariencia" colour="#9C27B0">
            <block type="say">
                <value name="MESSAGE">
                    <shadow type="text">
                        <field name="TEXT">¬°Hola!</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category name="Control" colour="#FF5722">
            <block type="repeat">
                <value name="TIMES">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
        </category>
    </xml>

    <script>
        // ---------- Configuraci√≥n del gato (estado) ----------
        let cat = {
            x: 200,
            y: 200,
            angle: 0,        // grados, 0 = derecha, 90 = arriba
            sayText: '',
            sayTimer: null
        };

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const posXSpan = document.getElementById('posX');
        const posYSpan = document.getElementById('posY');
        const angleSpan = document.getElementById('angle');
        const messageBox = document.getElementById('messageBox');

        // Dibujar el escenario y el gato
        function drawCat() {
            ctx.clearRect(0, 0, 400, 400);

            // Dibujar fondo estilo c√©sped
            ctx.fillStyle = '#b0e57c';
            ctx.fillRect(0, 0, 400, 400);
            // L√≠neas decorativas
            ctx.strokeStyle = '#8bc34a';
            ctx.lineWidth = 2;
            for (let i = 0; i < 10; i++) {
                ctx.beginPath();
                ctx.moveTo(i * 40, 0);
                ctx.lineTo(i * 40, 400);
                ctx.strokeStyle = '#8bc34a';
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(0, i * 40);
                ctx.lineTo(400, i * 40);
                ctx.stroke();
            }

            // Dibujar gato (tri√°ngulo para cuerpo, c√≠rculo cabeza)
            const headX = cat.x;
            const headY = cat.y;
            const headR = 20;

            // Direcci√≥n (l√≠nea)
            ctx.beginPath();
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.moveTo(headX, headY);
            const rad = cat.angle * Math.PI / 180;
            ctx.lineTo(headX + Math.cos(rad) * 40, headY - Math.sin(rad) * 40); // ojo: y invertido
            ctx.stroke();

            // Cuerpo
            ctx.fillStyle = '#FF9800';
            ctx.beginPath();
            ctx.ellipse(headX, headY, 22, 18, 0, 0, 2 * Math.PI);
            ctx.fill();
            ctx.strokeStyle = '#E65100';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Orejas
            ctx.fillStyle = '#FF9800';
            ctx.beginPath();
            ctx.moveTo(headX - 15, headY - 15);
            ctx.lineTo(headX - 5, headY - 30);
            ctx.lineTo(headX - 25, headY - 25);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(headX + 15, headY - 15);
            ctx.lineTo(headX + 5, headY - 30);
            ctx.lineTo(headX + 25, headY - 25);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // Ojos
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(headX - 8, headY - 4, 5, 0, 2 * Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(headX + 8, headY - 4, 5, 0, 2 * Math.PI);
            ctx.fill();
            ctx.fillStyle = '#333';
            ctx.beginPath();
            ctx.arc(headX - 8 + (Math.cos(rad)*2), headY - 4 - (Math.sin(rad)*2), 2, 0, 2*Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(headX + 8 + (Math.cos(rad)*2), headY - 4 - (Math.sin(rad)*2), 2, 0, 2*Math.PI);
            ctx.fill();

            // Bigotes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(headX-12, headY+2); ctx.lineTo(headX-25, headY+5); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(headX-12, headY+5); ctx.lineTo(headX-25, headY+2); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(headX+12, headY+2); ctx.lineTo(headX+25, headY+5); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(headX+12, headY+5); ctx.lineTo(headX+25, headY+2); ctx.stroke();

            // Si hay mensaje de "decir", dibujar bocadillo
            if (cat.sayText) {
                ctx.fillStyle = 'white';
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.ellipse(headX + 40, headY - 30, 45, 25, 0, 0, 2 * Math.PI);
                ctx.fill();
                ctx.stroke();
                ctx.fillStyle = '#333';
                ctx.font = 'bold 14px Arial';
                ctx.fillText(cat.sayText, headX + 18, headY - 33);
            }

            // Actualizar info en HTML
            posXSpan.textContent = Math.round(cat.x);
            posYSpan.textContent = Math.round(cat.y);
            angleSpan.textContent = cat.angle;
            messageBox.textContent = `üí¨ Mensaje: ${cat.sayText || '(vac√≠o)'}`;
        }

        // ---------- API que ser√° llamada desde los bloques ----------
        function mover(pasos) {
            let rad = cat.angle * Math.PI / 180;
            cat.x += Math.cos(rad) * pasos;
            cat.y -= Math.sin(rad) * pasos;  // y decrece hacia arriba
            // Limitar dentro del canvas (con margen)
            cat.x = Math.min(380, Math.max(20, cat.x));
            cat.y = Math.min(380, Math.max(20, cat.y));
            drawCat();
        }

        function girar(grados) {
            cat.angle = (cat.angle + grados) % 360;
            drawCat();
        }

        function decir(texto) {
            if (cat.sayTimer) clearTimeout(cat.sayTimer);
            cat.sayText = String(texto);
            drawCat();
            cat.sayTimer = setTimeout(() => {
                cat.sayText = '';
                drawCat();
            }, 1500);
        }

        // Reiniciar posici√≥n del gato
        function resetCat() {
            cat.x = 200;
            cat.y = 200;
            cat.angle = 0;
            if (cat.sayTimer) clearTimeout(cat.sayTimer);
            cat.sayText = '';
            drawCat();
        }

        // ---------- Definici√≥n de bloques personalizados Blockly ----------
        Blockly.Blocks['when_flag_clicked'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField('‚öë al presionar bandera');
                this.appendStatementInput('DO')
                    .setCheck(null);
                this.setColour('#FFC107');
                this.setTooltip('Comenzar al hacer clic en la bandera');
                this.setPreviousStatement(false);
                this.setNextStatement(false);
            }
        };

        Blockly.Blocks['move_forward'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField('mover');
                this.appendValueInput('STEPS')
                    .setCheck('Number')
                    .appendField('pasos');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#4CAF50');
                this.setTooltip('Mueve el gato hacia adelante');
            }
        };

        Blockly.Blocks['turn_right'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField('girar');
                this.appendValueInput('DEGREES')
                    .setCheck('Number')
                    .appendField('grados a la derecha');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#4CAF50');
                this.setTooltip('Gira el gato a la derecha');
            }
        };

        Blockly.Blocks['say'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField('decir');
                this.appendValueInput('MESSAGE')
                    .setCheck('String')
                    .appendField('mensaje');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#9C27B0');
                this.setTooltip('Mostrar un mensaje');
            }
        };

        Blockly.Blocks['repeat'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField('repetir');
                this.appendValueInput('TIMES')
                    .setCheck('Number')
                    .appendField('veces');
                this.appendStatementInput('DO')
                    .setCheck(null)
                    .appendField('hacer');
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour('#FF5722');
                this.setTooltip('Repite un bloque varias veces');
            }
        };

        // Generadores de c√≥digo JavaScript
        Blockly.JavaScript['when_flag_clicked'] = function(block) {
            let statements = Blockly.JavaScript.statementToCode(block, 'DO');
            return '(function() {\n' + statements + '})();\n';
        };

        Blockly.JavaScript['move_forward'] = function(block) {
            let steps = Blockly.JavaScript.valueToCode(block, 'STEPS', Blockly.JavaScript.ORDER_NONE) || '10';
            return 'mover(' + steps + ');\n';
        };

        Blockly.JavaScript['turn_right'] = function(block) {
            let degrees = Blockly.JavaScript.valueToCode(block, 'DEGREES', Blockly.JavaScript.ORDER_NONE) || '15';
            return 'girar(' + degrees + ');\n';
        };

        Blockly.JavaScript['say'] = function(block) {
            let message = Blockly.JavaScript.valueToCode(block, 'MESSAGE', Blockly.JavaScript.ORDER_NONE) || "'Hola'";
            return 'decir(' + message + ');\n';
        };

        Blockly.JavaScript['repeat'] = function(block) {
            let times = Blockly.JavaScript.valueToCode(block, 'TIMES', Blockly.JavaScript.ORDER_ASSIGNMENT) || '10';
            let statements = Blockly.JavaScript.statementToCode(block, 'DO');
            return 'for (var i__ = 0; i__ < ' + times + '; i__++) {\n' + statements + '}\n';
        };

        // ---------- Inicializar Blockly ----------
        const toolbox = document.getElementById('toolbox');
        const blocklyDiv = document.getElementById('blocklyDiv');
        const workspace = Blockly.inject(blocklyDiv, {
            toolbox: toolbox,
            trashcan: true,
            scrollbars: true,
            horizontalLayout: false,
            toolboxPosition: 'start',
            sounds: false,
            media: 'https://unpkg.com/blockly/media/'
        });

        // Agregar algunos bloques iniciales para empezar (opcional)
        Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(
            '<xml>' +
            '<block type="when_flag_clicked" x="20" y="20"></block>' +
            '</xml>'
        ), workspace);

        // ---------- Botones ----------
        document.getElementById('runButton').addEventListener('click', function() {
            let code = Blockly.JavaScript.workspaceToCode(workspace);
            console.log("C√≥digo generado:\n", code);
            try {
                eval(code);
            } catch (e) {
                alert("Error al ejecutar los bloques: " + e.message);
            }
        });

        document.getElementById('resetButton').addEventListener('click', function() {
            resetCat();
        });

        document.getElementById('clearButton').addEventListener('click', function() {
            workspace.clear();
            resetCat();
        });

        // Dibujar estado inicial
        resetCat();

        // Ajustar tama√±o del bloque al redimensionar
        window.addEventListener('resize', function() {
            Blockly.svgResize(workspace);
        });
    </script>
</body>
</html>
